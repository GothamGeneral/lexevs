<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL MAP 2.0//EN" 
	"http://www.ibatis.com/dtd/sql-map-2.dtd">
<sqlMap namespace="Versions">

	<resultMap id="entryStateResult" class="org.LexGrid.versions.EntryState">
		<result property="containingRevision" column="currentRevisionId" />
		<result property="relativeOrder" column="relativeOrder" />
		<result property="changeType" column="changeType" />
		<result property="prevRevision" column="previousRevisionId" />
	</resultMap>
	
	<select id="getSystemReleaseGuidByUri" parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter" resultClass="string">
		SELECT
			releaseGuid
		FROM
			$prefix$systemRelease
		WHERE
			releaseURI = #param1#	
     </select>

	<select id="getEntryStateById" parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter" resultMap="Versions.entryStateResult">
		SELECT
			changeType,
			relativeOrder,
			revisionGuid,
			prevRevisionGuid
		FROM
			$prefix$entryState
		WHERE
			entryStateGuid = #param1#
		
     </select>

	<select id="getRevisionGuid" parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter" resultClass="string">
		SELECT			
			revisionGuid
		FROM
			$prefix$revision
		WHERE
			revisionId = #param1#
     </select>
     
	<update id="updateEntryStateById" parameterClass="map">
		UPDATE entryState
		SET 
			changeType = #entryState.changeType#
		where
			entryStateId = #id#
 	</update>
 	
 	<insert id="insertSystemRelease" parameterClass="org.lexevs.dao.database.ibatis.versions.parameter.InsertSystemReleaseBean">
		INSERT INTO $prefix$systemRelease (
			releaseGuid,
			releaseURI,
			releaseId,
			releaseDate,
			basedOnRelease,
			releaseAgency,
			description
			)
		VALUES (
			#releaseUId#,
			#systemRelease.releaseURI#,
			#systemRelease.releaseId#,
			#systemRelease.releaseDate#,
			#systemRelease.basedOnRelease#,
			#systemRelease.releaseAgency#,
			#systemRelease.entityDescription.content#
			)
 	</insert>
 	
 	<insert id="insertRevision" parameterClass="org.lexevs.dao.database.ibatis.versions.parameter.InsertRevisionBean">
		INSERT INTO $prefix$revision (
			revisionGuid,
			releaseGuid,			
			revisionId,
			changeAgent,
			revisionDate,
			revAppliedDate,
			editOrder,
			changeInstructions,
			description
			)
		VALUES (
			#revisionGuid#,
			#releaseGuid#,
			#revision.revisionId#,
			#revision.changeAgent#,
			#revision.revisionDate#,
			#revAppliedDate#,
			#revision.editOrder#,
			#revision.changeInstructions#,
			#revision.entityDescription.content#
			)
 	</insert>
 	
 	<insert id="insertEntryState" parameterClass="org.lexevs.dao.database.ibatis.versions.parameter.InsertEntryStateBean">
		INSERT INTO $prefix$entryState (
			entryStateGuid,
			entryGuid,
			entryType,
			changeType,
			relativeOrder,
			revisionGuid,
			prevRevisionGuid,
			prevEntryStateGuid
			)
		VALUES (
			#entryStateUId#,
			#entryUId#,
			#entryType#,
			#entryState.changeType#,
			#entryState.relativeOrder#,
			#revisionUId#,
			#prevRevisionUId#,
			#previousEntryStateUId#
			)
 	</insert>
 	
 	<select id="getRevisionGuidFromId" parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter" resultClass="string">
   		SELECT
   			revisionGuid
   		FROM
   			$prefix$revision
		WHERE
			revisionId = #param1#
   </select>

	<select id="checkEntryStateExists" remapResults="true"
		parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter"
		resultClass="string">
		SELECT
			count(1)
		FROM
			$prefix$entryState es
		WHERE
			es.entryStateGuid = #param1#
     </select>
    
</sqlMap>