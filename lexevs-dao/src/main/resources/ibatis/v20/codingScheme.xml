<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL MAP 2.0//EN" 
	"http://www.ibatis.com/dtd/sql-map-2.dtd">
<sqlMap namespace="CodingScheme">

	<typeAlias alias="codingScheme" type="org.LexGrid.codingSchemes.CodingScheme" />
	<typeAlias alias="codingSchemeSummary" type="org.LexGrid.LexBIG.DataModel.Core.CodingSchemeSummary" />

	<resultMap id="codingSchemeResult" class="codingScheme" groupBy="codingSchemeName,representsVersion">
		<result property="codingSchemeName" column="codingSchemeName" />
		<result property="codingSchemeURI" column="codingSchemeUri" />
		<result property="representsVersion" column="representsVersion" />
		<result property="formalName" column="formalName" />
		<result property="defaultLanguage" column="defaultLanguage" />
		<result property="approxNumConcepts" column="approxNumConcepts" />
		<result property="entityDescription.content" column="description" />
		<result property="copyright.content" column="copyright" />
		<result property="isActive" column="isActive" />
		<result property="entryState" resultMap="Versions.entryStateResult" />
		<result property="_sourceList" resultMap="CodingScheme.sourceResult"/>
		<result property="_localNameList" resultMap="CodingScheme.localNameResult"/>
	</resultMap>

	<resultMap id="codingSchemeSummaryResult" class="codingSchemeSummary">
		<result property="localName" column="codingSchemeName" />
		<result property="codingSchemeURI" column="codingSchemeUri" />
		<result property="representsVersion" column="representsVersion" />
		<result property="formalName" column="formalName" />
		<result property="codingSchemeDescription.content" column="description" />
	</resultMap>
	
	<delete id="deleteCodingSchemeById" parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter">
		DELETE FROM
			$prefix$codingScheme
		WHERE
			codingSchemeGuid = #param1#
	</delete>
	
	
	<sql id="getCodingSchemeFragment">
		SELECT
			cs.codingSchemeGuid,
			cs.codingSchemeName,
			cs.codingSchemeUri,
			cs.representsVersion,
			cs.formalName,
			cs.defaultLanguage,
			cs.approxNumConcepts,
			cs.description,
			cs.copyright,
			cs.isActive,
			cs.owner,
			cs.status,
			cs.effectiveDate,
			cs.expirationDate,
			es.changeType,
			es.relativeOrder,
			es.revisionGuid,
			currentRevision.revisionId currentRevisionId,
			previousRevision.revisionId previousRevisionId,
			csmaSource.*,
			csmaLocalName.attributeValue localNameValue
		FROM
			$prefix$codingScheme cs
			
		LEFT JOIN
			$actualTableSetPrefix$entryState es
		ON
			cs.entryStateGuid = es.entryStateGuid
			
		LEFT JOIN
			${defaultPrefix}revision currentRevision
		ON 
			es.revisionGuid = currentRevision.revisionGuid
			
		LEFT JOIN
			${defaultPrefix}revision previousRevision
		ON 
			es.prevRevisionGuid = previousRevision.revisionGuid
	</sql>
			
	<sql id="getCodingSchemeMultiAttribsFragment">
		LEFT JOIN
			$prefix$csMultiAttrib csmaSource
		ON (
			csmaSource.codingSchemeGuid = cs.codingSchemeGuid
		AND
			csmaSource.attributeType = 'source'
			)
		LEFT JOIN
			$prefix$csMultiAttrib csmaLocalName
		ON (
			csmaLocalName.codingSchemeGuid = cs.codingSchemeGuid
		AND
			csmaLocalName.attributeType = 'localName'
			)
	</sql>
	
	<sql id="getHistoryCodingSchemeMultiAttribsFragment">
		LEFT JOIN
			${defaultPrefix}h_csMultiAttrib csmaSource
		ON (
			csmaSource.codingSchemeGuid = cs.codingSchemeGuid
		AND
			csmaSource.attributeType = 'source'
		AND
			csmaSource.entryStateGuid = cs.entryStateGuid	
			)
			
		LEFT JOIN
			${defaultPrefix}h_csMultiAttrib csmaLocalName
		ON (
			csmaLocalName.codingSchemeGuid = cs.codingSchemeGuid
		AND
			csmaLocalName.attributeType = 'localName'
		AND
			csmaLocalName.entryStateGuid = cs.entryStateGuid	
			)
	</sql>
	
	
	<select id="getCodingSchemeById" 
		parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter" 
		resultMap="CodingScheme.codingSchemeResult"
		remapResults="true">
		<include refid="getCodingSchemeFragment"/>
		<include refid="getCodingSchemeMultiAttribsFragment"/>
		WHERE
			cs.codingSchemeGuid = #param1#

     </select>
     
    <select id="getCodingSchemeSummaryByUriAndVersion" 
    	parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameterTuple"
    	resultMap="codingSchemeSummaryResult"
     	remapResults="true">
		SELECT
			codingSchemeName,
			codingSchemeURI,
			representsVersion,
			formalName,
			description
		FROM 
			$prefix$codingScheme
		WHERE
			codingSchemeURI =
			#param1#
		AND
			representsVersion =
			#param2#
	</select>
	
	<select id="getCodingSchemeByNameAndVersion" 
		parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameterTuple" 
		resultMap="codingSchemeResult"
		remapResults="true">
		<include refid="getCodingSchemeFragment"/>
		<include refid="getCodingSchemeMultiAttribsFragment"/>
		WHERE
			cs.codingSchemeName = #param1#
		AND
			cs.representsVersion = #param2#
     </select>
     
     <select id="getCodingSchemeByIdAndRevisionId" parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameterTuple" resultMap="codingSchemeResult">
		<include refid="getCodingSchemeFragment"/>
		<include refid="getHistoryCodingSchemeMultiAttribsFragment"/>
		WHERE
			cs.codingSchemeGuid = #param1#
		AND
			currentRevision.revisionGuid = #param2#	
     </select>
     
     <select id="getCodingSchemeIdByNameAndVersion" 
     	parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameterTuple" 
     	resultClass="string" 
     	remapResults="true">
		SELECT
			codingSchemeGuid
		FROM
			$prefix$codingScheme
		WHERE
			codingSchemeName = #param1#
		AND
			representsVersion = #param2#
     </select>
     
     <select id="getCodingSchemeIdByUriAndVersion" 
     	parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameterTuple" 
     	resultClass="string"
     	remapResults="true">
		SELECT
			codingSchemeGuid
		FROM
			$prefix$codingScheme
		WHERE
			codingSchemeUri = #param1#
		AND
			representsVersion = #param2#
     </select>
     
     <select id="getEntryStateId" parameterClass="map" remapResults="true"> resultClass="string">
		SELECT
			entryStateId
		FROM
			codingScheme
		WHERE
			codingSchemeName = #codingSchemeName#
		AND
			representsVersion = #representsVersion#
		AND
			isCurrentRelease = #isCurrentRelease#
     </select>
   
	<update id="updateCodingSchemeById" 
		parameterClass="org.lexevs.dao.database.ibatis.codingscheme.parameter.InsertOrUpdateCodingSchemeBean">
		UPDATE 
			$prefix$codingScheme
		SET 
		
   		  <dynamic prepend=" ">
			<isNotNull prepend="," property="codingScheme.codingSchemeName">
				codingSchemeName = #codingScheme.codingSchemeName#
			</isNotNull>
			<isNotNull prepend="," property="codingScheme.codingSchemeURI">
				codingSchemeUri = #codingScheme.codingSchemeURI#
			</isNotNull>
			<isNotNull prepend="," property="codingScheme.representsVersion">
				representsVersion = #codingScheme.representsVersion#
			</isNotNull>
			<isNotNull prepend="," property="codingScheme.formalName">
				formalName = #codingScheme.formalName#
			</isNotNull>
			<isNotNull prepend="," property="codingScheme.approxNumConcepts">
				approxNumConcepts = #codingScheme.approxNumConcepts#
			</isNotNull>
			<isNotNull prepend="," property="codingScheme.defaultLanguage">
				defaultLanguage = #codingScheme.defaultLanguage#
			</isNotNull>
			<isNotNull prepend="," property="codingScheme.entityDescription.content">
				description = #codingScheme.entityDescription.content#
			</isNotNull>
			<isNotNull prepend="," property="codingScheme.copyright.content">
				copyright = #codingScheme.copyright.content#
			</isNotNull>
		</dynamic>

		WHERE 
			codingSchemeGuid = #id#
 	</update>

	<insert id="insertCodingScheme" parameterClass="org.lexevs.dao.database.ibatis.codingscheme.parameter.InsertOrUpdateCodingSchemeBean">
		
		INSERT INTO $prefix$codingScheme (
			codingSchemeGuid,
			codingSchemeName,
			codingSchemeUri,
			representsVersion,
			formalName,
			defaultLanguage,
			approxNumConcepts,
			description,
			copyright,
			isActive,
			owner,
			status,
			effectiveDate,
			expirationDate,
			entryStateGuid
		) VALUES (
			#id#, 
			#codingScheme.codingSchemeName#, 
			#codingScheme.codingSchemeURI#, 
			#codingScheme.representsVersion#,
			#codingScheme.formalName#,
			#codingScheme.defaultLanguage#,
			#codingScheme.approxNumConcepts#,
			#codingScheme.entityDescription.content#,
			#codingScheme.copyright.content#,
			#codingScheme.isActive#,
			#codingScheme.owner#,
			#codingScheme.status#,
			#codingScheme.effectiveDate#,
			#codingScheme.expirationDate#,
			#entryStateId#
		)
  </insert>
  
  
  	
	<select id="getDistinctPropertyNames" 
		remapResults="true"
     	parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter" 
     	resultClass="string">
     SELECT DISTINCT
     	prop.propertyName
     FROM
     	$prefix$property prop
	 INNER JOIN 
	 	$prefix$entity entity
	 ON 
	 	prop.referenceGuid = entity.entityGuid
	 INNER JOIN
		$prefix$codingscheme cs
	 ON 
	 	entity.codingSchemeGuid = cs.codingSchemeGuid
	 WHERE
		cs.codingSchemeGuid = #param1#
     </select>
     
     	<select id="getDistinctEntityTypes" remapResults="true"
     	parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter" resultClass="string">
     SELECT DISTINCT
     	type.entityType
     FROM
     	$prefix$entityType type
	 INNER JOIN 
	 	$prefix$entity entity
	 ON 
	 	type.entityGuid = entity.entityGuid
	 INNER JOIN
		$prefix$codingscheme cs
	 ON 
	 	entity.codingSchemeGuid = cs.codingSchemeGuid
	 WHERE
		cs.codingSchemeGuid = #param1#
     </select>
     
      <select id="getDistinctNamespaces" remapResults="true"
     	parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter" resultClass="string">
     SELECT DISTINCT
     	entity.entityCodeNamespace
     FROM
     	$prefix$entity entity
	 WHERE
		entity.codingSchemeGuid = #param1#
     </select>
     
      <select id="getDistinctFormats" remapResults="true"
     	parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter" resultClass="string">
        SELECT DISTINCT
     	prop.format
     FROM
     	$prefix$property prop
	 INNER JOIN 
	 	$prefix$entity entity
	 ON 
	 	prop.referenceGuid = entity.entityGuid
	 INNER JOIN
		$prefix$codingscheme cs
	 ON 
	 	entity.codingSchemeGuid = cs.codingSchemeGuid
	 WHERE
		cs.codingSchemeGuid = #param1#
	 AND
	 	prop.format IS NOT NULL
     </select>
     
      <select id="getDistinctLanguages" remapResults="true"
     	parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter" resultClass="string">
        SELECT DISTINCT
     	prop.language
     FROM
     	$prefix$property prop
	 INNER JOIN 
	 	$prefix$entity entity
	 ON 
	 	prop.referenceGuid = entity.entityGuid
	 INNER JOIN
		$prefix$codingscheme cs
	 ON 
	 	entity.codingSchemeGuid = cs.codingSchemeGuid
	 WHERE
		cs.codingSchemeGuid = #param1#
	 AND
	 	prop.language IS NOT NULL
			
	  UNION
		
		SELECT
			cs.defaultLanguage
		FROM
			$prefix$codingScheme cs
		WHERE
			cs.codingSchemeGuid = #param1#
     </select>


	<sql id="distinctPropQualFragment">
		FROM
			$prefix$propertyMultiAttrib propQual
		INNER JOIN
			$prefix$property prop
		ON
			prop.propertyGuid = propQual.propertyGuid
		INNER JOIN
			$prefix$entity entity
		ON
			prop.referenceGuid = entity.entityGuid
		INNER JOIN
			$prefix$codingscheme cs
		ON
			entity.codingSchemeGuid = cs.codingSchemeGuid
		WHERE
			cs.codingSchemeGuid = #param1#
	</sql>

	<select id="getDistinctPropertyQualifierTypes" remapResults="true"
		parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter"
		resultClass="string">
		SELECT DISTINCT
			propQual.attributeType
		<include refid="distinctPropQualFragment"/>
     </select>
     
     <select id="getDistinctPropertyQualifierNames" remapResults="true"
		parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter"
		resultClass="string">
		SELECT DISTINCT
			propQual.attributeId
		<include refid="distinctPropQualFragment"/>
     </select>
    
</sqlMap>