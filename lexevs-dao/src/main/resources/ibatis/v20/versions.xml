<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL MAP 2.0//EN" 
	"http://www.ibatis.com/dtd/sql-map-2.dtd">
<sqlMap namespace="Versions">

	<resultMap id="entryStateResult" class="org.LexGrid.versions.EntryState">
		<result property="containingRevision" column="currentRevisionId" />
		<result property="relativeOrder" column="relativeOrder" />
		<result property="changeType" column="changeType" />
		<result property="prevRevision" column="previousRevisionId" />
	</resultMap>
	
	<select id="getSystemReleaseGuidByUri" parameterClass="string" resultClass="string">
		SELECT
			releaseGuid
		FROM
			${defaultPrefix}systemRelease
		WHERE
			releaseURI = #param1#	
     </select>

	<select id="getEntryStateById" parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter" resultMap="Versions.entryStateResult">
		SELECT
			changeType,
			relativeOrder,
			revisionGuid,
			prevRevisionGuid
		FROM
			$prefix$entryState
		WHERE
			entryStateGuid = #param1#
		
     </select>
     
	<update id="updateEntryStateById" parameterClass="map">
		UPDATE entryState
		SET 
			changeType = #entryState.changeType#
		where
			entryStateId = #id#
 	</update>
 	
 	<insert id="insertSystemRelease" parameterClass="org.lexevs.dao.database.ibatis.versions.parameter.InsertSystemReleaseBean">
		INSERT INTO ${defaultPrefix}systemRelease (
			releaseGuid,
			releaseURI,
			releaseId,
			releaseDate,
			basedOnRelease,
			releaseAgency,
			description
			)
		VALUES (
			#releaseUId#,
			#systemRelease.releaseURI#,
			#systemRelease.releaseId#,
			#systemRelease.releaseDate#,
			#systemRelease.basedOnRelease#,
			#systemRelease.releaseAgency#,
			#systemRelease.entityDescription.content#
			)
 	</insert>
 	
 	<insert id="insertRevision" parameterClass="org.lexevs.dao.database.ibatis.versions.parameter.InsertRevisionBean">
		INSERT INTO ${defaultPrefix}revision (
			revisionGuid,
			releaseGuid,			
			revisionId,
			changeAgent,
			revisionDate,
			revAppliedDate,
			editOrder,
			changeInstructions,
			description
			)
		VALUES (
			#revisionGuid#,			
			<isPropertyAvailable property="releaseGuid">
				#releaseGuid#,
			</isPropertyAvailable>	
			<isNotPropertyAvailable property="releaseGuid">
				null,
			</isNotPropertyAvailable>		
			#revision.revisionId#,			
			<isPropertyAvailable property="revision.changeAgent[0]">
				#revision.changeAgent[0]#,
			</isPropertyAvailable>	
			<isNotPropertyAvailable property="revision.changeAgent[0]">
				null,
			</isNotPropertyAvailable>		
			<isPropertyAvailable property="revision.revisionDate">
				#revision.revisionDate#,
			</isPropertyAvailable>	
			<isNotPropertyAvailable property="revision.revisionDate">
				null,
			</isNotPropertyAvailable>		
			#revAppliedDate#,			
			<isPropertyAvailable property="revision.editOrder">
				#revision.editOrder#,
			</isPropertyAvailable>
			<isNotPropertyAvailable property="revision.editOrder">
				null,
			</isNotPropertyAvailable>				
			<isPropertyAvailable property="revision.changeInstructions">
				#revision.changeInstructions.content#,
			</isPropertyAvailable>
			<isNotPropertyAvailable property="revision.changeInstructions">
				null,
			</isNotPropertyAvailable>
			<isPropertyAvailable property="revision.entityDescription">
				#revision.entityDescription.content#				
			</isPropertyAvailable>
			<isNotPropertyAvailable property="revision.entityDescription">
				null
			</isNotPropertyAvailable>
			)
 	</insert>
 	
 	<insert id="insertEntryState" parameterClass="org.lexevs.dao.database.ibatis.versions.parameter.InsertEntryStateBean">
		INSERT INTO $prefix$entryState (
			entryStateGuid,
			entryGuid,
			entryType,
			changeType,
			relativeOrder,
			revisionGuid,
			prevRevisionGuid,
			prevEntryStateGuid
			)
		VALUES (
			#entryStateUId#,
			#entryUId#,
			#entryType#,
			#entryState.changeType#,
			#entryState.relativeOrder#,
			#revisionUId#,
			#prevRevisionUId#,
			#previousEntryStateUId#
			)
 	</insert>
 	
 	<select id="getRevisionGuidFromId" parameterClass="string" resultClass="string">
   		SELECT
   			revisionGuid
   		FROM
   			${defaultPrefix}revision
		WHERE
			revisionId = #param1#
   </select>

	<select id="checkEntryStateExists" remapResults="true"
		parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter"
		resultClass="string">
		SELECT
			count(1)
		FROM
			$prefix$entryState es
		WHERE
			es.entryStateGuid = #param1#
     </select>
     
	<delete id="deleteAllEntrySateEntriesByEntryUId" parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter">
		DELETE FROM
			$prefix$entryState
		WHERE
			entryGuid = #param1#
	</delete>
	
	<delete id="deleteAllCodingSchemeEntrySatesByCodingSchemeUId" parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter">
		DELETE FROM
			$prefix$entryState
		WHERE
			entryGuid = #param1#
	</delete>
	
	<delete id="deletaAllCSPropEntryStateOfCodingScheme" parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameterTuple">
		DELETE FROM
			$prefix$entryState
		WHERE
			entryType = #param1#
		AND
			entryGuid 
		IN	( 
			SELECT
				prop.propertyGuid
			FROM
				$prefix$codingScheme cs,
				$prefix$property prop
			WHERE
				prop.referenceGuid = cs.codingSchemeGuid 
			AND
				cs.codingSchemeGuid = #param2#
			)
	</delete>
	
    <delete id="deletaAllEntityPropertyEntryStateOfCodingScheme" parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameterTuple">
		DELETE FROM
			$prefix$entryState
		WHERE
			entryType = #param1#
		AND
			entryGuid 
		IN	( 
			SELECT
				prop.propertyGuid
			FROM
				$prefix$entity ent,
				$prefix$property prop
			WHERE
				prop.referenceGuid = ent.entityGuid
			AND
				ent.codingSchemeGuid = #param2#
			)
	</delete>
	
    <delete id="deletaAllEntityEntryStateOfCodingScheme" parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameterTuple">
		DELETE FROM
			$prefix$entryState
		WHERE
			entryType = #param1#
		AND
			entryGuid 
		IN	( 
			SELECT
				entityGuid
			FROM
				$prefix$entity ent
			WHERE
				ent.codingSchemeGuid = #param2#
			)
	</delete>
	
    <delete id="deletaAllRelationPropertyEntryStateOfCodingScheme" parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameterTuple">
		DELETE FROM
			$prefix$entryState
		WHERE
			entryType = #param1#
		AND
			entryGuid 
		IN	( 
			SELECT
				prop.propertyGuid
			FROM
				$prefix$relation rel,
				$prefix$property prop
			WHERE
				prop.referenceGuid = rel.relationGuid
			AND
				rel.codingSchemeGuid = #param2#
			)
	</delete>
	
	<delete id="deletaAllRelationEntryStateOfCodingScheme" parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameterTuple">
		DELETE FROM
			$prefix$entryState
		WHERE
			entryType = #param1#
		AND
			entryGuid 
		IN	( 
			SELECT
				relationGuid
			FROM
				$prefix$relation rel
			WHERE
				rel.codingSchemeGuid = #param2#
			)
	</delete>
	
	<delete id="deletaAllAssnTargetEntryStateOfCodingScheme" parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameterTuple">
		DELETE FROM
			$prefix$entryState
		WHERE
			entryType = #param1#
		AND
			entryGuid 
		IN	( 
			SELECT
				assnTarget.entityAssnsGuid
			FROM
				$prefix$relation rel,
				$prefix$associationPredicate assnPred,
				$prefix$entityAssnsToEntity assnTarget
			WHERE
				assnTarget.associationPredicateGuid = assnPred.associationPredicateGuid
			AND
				assnPred.relationGuid = rel.relationGuid
			AND
				rel.codingSchemeGuid = #param2#
			)
	</delete>
	
    <delete id="deletaAllAssnDataEntryStateOfCodingScheme" parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameterTuple">
		DELETE FROM
			$prefix$entryState
		WHERE
			entryType = #param1#
		AND
			entryGuid 
		IN	( 
			SELECT
				assnData.entityAssnsDataGuid
			FROM
				$prefix$relation rel,
				$prefix$associationPredicate assnPred,
				$prefix$entityAssnsToData assnData
			WHERE
				assnData.associationPredicateGuid = assnPred.associationPredicateGuid
			AND
				assnPred.relationGuid = rel.relationGuid
			AND
				rel.codingSchemeGuid = #param2#
			)
	</delete>
	
	<delete id="deletaAllEntityPropEntryStateOfEntity" parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameterTuple">
		DELETE FROM
			$prefix$entryState
		WHERE
			entryType = #param1#
		AND
			entryGuid 
		IN	( 
			SELECT
				prop.propertyGuid
			FROM
				$prefix$entity ent,
				$prefix$property prop
			WHERE
				ent.entityGuid = #param2#
			AND
				ent.entityGuid = prop.referenceGuid				
			)
	</delete>
	
	<delete id="deletaAllAssnTargetEntryStateOfRelation" parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameterTuple">
		DELETE FROM
			$prefix$entryState
		WHERE
			entryType = #param1#
		AND
			entryGuid 
		IN	( 
			SELECT
				assnTarget.entityAssnsGuid
			FROM
				$prefix$relation rel,
				$prefix$associationPredicate assnPred,
				$prefix$entityAssnsToEntity assnTarget
			WHERE
				assnTarget.associationPredicateGuid = assnPred.associationPredicateGuid
			AND
				assnPred.relationGuid = rel.relationGuid
			AND
				rel.relationGuid = #param2#
			)
	</delete>
	
	<delete id="deletaAllAssnDataEntryStateOfRelation" parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameterTuple">
		DELETE FROM
			$prefix$entryState
		WHERE
			entryType = #param1#
		AND
			entryGuid 
		IN	( 
			SELECT
				assnData.entityAssnsDataGuid
			FROM
				$prefix$relation rel,
				$prefix$associationPredicate assnPred,
				$prefix$entityAssnsToData assnData
			WHERE
				assnData.associationPredicateGuid = assnPred.associationPredicateGuid
			AND
				assnPred.relationGuid = rel.relationGuid
			AND
				rel.relationGuid = #param2#
			)
	</delete>

    <delete id="deletaAllRelationPropertyEntryStateOfRelation" parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameterTuple">
		DELETE FROM
			$prefix$entryState
		WHERE
			entryType = #param1#
		AND
			entryGuid 
		IN	( 
			SELECT
				prop.propertyGuid
			FROM
				$prefix$relation rel,
				$prefix$property prop
			WHERE
				prop.referenceGuid = rel.relationGuid
			AND
				rel.relationGuid = #param2#
			)
	</delete>	
	
	<select id="isValidRevision" remapResults="true"
		parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter"
		resultClass="string">
		SELECT
			count(1)
		FROM
			$prefix$revision rev
		WHERE
			rev.revisionId = #param1#
     </select>
</sqlMap>