<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL MAP 2.0//EN" 
	"http://www.ibatis.com/dtd/sql-map-2.dtd">
<sqlMap namespace="Entity">

	<typeAlias alias="entity" type="org.lexevs.dao.database.lazyload.LazyLoadableEntity" />

	<resultMap id="entityResult" class="entity" groupBy="entityCode,entityCodeNamespace">
		<result property="entityId" column="entityGuid" />
		<result property="codingSchemeId" column="codingSchemeGuid" />
		<result property="entityCode" column="entityCode" />
		<result property="entityCodeNamespace" column="entityCodeNamespace" />
		<result property="entityDescription.content" column="description" />
		<result property="_entityTypeList" resultMap="Entity.entityTypeResult"/>
	</resultMap>
	
	<sql id="getEntityFragment">
		SELECT
			entity.codingSchemeGuid,
			entity.entityGuid,
			entity.entityCode,
			entity.entityCodeNamespace,
			entity.description,
			entityType.entityType
		FROM
			$prefix$entity entity
		LEFT JOIN
			$prefix$entityType entityType
		ON
			entity.entityGuid =
			entityType.entityGuid
	</sql>
	
	<select id="getEntityCount" parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter" resultClass="int">
		SELECT
			COUNT(entityGuid)
		FROM
			$prefix$entity
		WHERE
			codingSchemeGuid = #param1#
     </select>

	<select id="getEntityByCodeAndNamespace" parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameterTuple" resultMap="Entity.entityResult">
		<include refid="getEntityFragment"/>
		WHERE
			entityCode = #param1#
		AND
			entityCodeNamespace = #param2#
     </select>
     
   
     
     <select id="getAllEntitiesOfCodingScheme" parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter" 
     	resultMap="Entity.entityResult">
		<include refid="getEntityFragment"/>
		WHERE
			codingSchemeGuid = #param1#
     </select>
     
     <insert id="insertEntity" parameterClass="org.lexevs.dao.database.ibatis.entity.parameter.InsertEntityBean">
		INSERT INTO $prefix$entity (
			entityGuid,
			codingSchemeGuid,
			entityCode,
			entityCodeNamespace,
			isDefined,
			isAnonymous,
			isActive,
			description,
			owner,
			status,
			effectiveDate,
			expirationDate,
			entryStateGuid
		) VALUES (
			#id#, 
			#codingSchemeId#,
			#entity.entityCode#, 
			#entity.entityCodeNamespace#, 
			#entity.isDefined#,
			#entity.isAnonymous#,
			#entity.isActive#,
			#entity.entityDescription.content#,
			#entity.owner#,
			#entity.status#,
			#entity.effectiveDate#,
			#entity.expirationDate#,
			#entryStateId#
		)
  </insert>
    
</sqlMap>