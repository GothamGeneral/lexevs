<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL MAP 2.0//EN" 
	"http://www.ibatis.com/dtd/sql-map-2.dtd">
<sqlMap namespace="ValueSetDefinition">

	<typeAlias alias="valueSetDefinition" type="org.LexGrid.valueSets.ValueSetDefinition" />
	<typeAlias alias="definitionEntry" type="org.LexGrid.valueSets.DefinitionEntry" />
	<typeAlias alias="entityReference" type="org.LexGrid.valueSets.EntityReference" />	
	<typeAlias alias="codingSchemeReference" type="org.LexGrid.valueSets.CodingSchemeReference" />
	<typeAlias alias="valueSetDefinitionReference" type="org.LexGrid.valueSets.ValueSetDefinitionReference" />
	<typeAlias alias="propertyReference" type="org.LexGrid.valueSets.PropertyReference" />
	<typeAlias alias="propertyMatchValue" type="org.LexGrid.valueSets.PropertyMatchValue" />
	<typeAlias alias="valueSetDefinitionBean" type="org.lexevs.dao.database.ibatis.valuesets.parameter.InsertValueSetDefinitionBean"/>
	
	<resultMap id="valueSetDefinitionResult" class="valueSetDefinition">
		<result property="valueSetDefinitionURI" column="valueSetDefURI" />
		<result property="valueSetDefinitionName" column="valueSetDefName" />
		<result property="defaultCodingScheme" column="defaultCodingScheme" />
		<result property="conceptDomain" column="conceptDomain" />
		<result property="entityDescription.content" column="description" />
		<result property="isActive" column="isActive" />
		<result property="owner" column="owner" />
		<result property="status" column="status" />
		<result property="effectiveDate" column="effectiveDate" />
		<result property="expirationDate" column="expirationDate" />
	</resultMap>
	
	<resultMap id="valueSetDefinitionMetaDataResult" class="valueSetDefinitionBean" groupBy="uid">
		<result property="uid" column="valueSetDefGuid" />
		<result property="valueSetDefinition.valueSetDefinitionURI" column="valueSetDefURI" />
		<result property="valueSetDefinition.valueSetDefinitionName" column="valueSetDefName" />
		<result property="valueSetDefinition.defaultCodingScheme" column="defaultCodingScheme" />
		<result property="valueSetDefinition.conceptDomain" column="conceptDomain" />
		<result property="valueSetDefinition.entityDescription.content" column="description" />
		<result property="systemReleaseUId" column="releaseGuid" />
		<result property="valueSetDefinition.isActive" column="isActive" />
		<result property="valueSetDefinition.owner" column="owner" />
		<result property="valueSetDefinition.status" column="status" />
		<result property="valueSetDefinition.effectiveDate" column="effectiveDate" />
		<result property="valueSetDefinition.expirationDate" column="expirationDate" />
		<result property="entryStateUId" column="entryStateGuid" />
		<result property="vsMultiAttribList" resultMap="VSMultiAttrib.vsMultiAttribResultBean"/>
	</resultMap>
	
	<resultMap  id="definitionEntryResult" class="definitionEntry">
		<result property="ruleOrder" column="ruleOrder"/>
		<result property="operator" column="operator"/>
		<result property="isActive" column="isActive" />
		<result property="owner" column="owner" />
		<result property="status" column="status" />
		<result property="effectiveDate" column="effectiveDate" />
		<result property="expirationDate" column="expirationDate" />
		<result property="codingSchemeReference" resultMap="ValueSetDefinition.codingSchemeReferenceResult" />
		<result property="valueSetDefinitionReference" resultMap="ValueSetDefinition.valueSetDefinitionReferenceResult" />
		<result property="entityReference" resultMap="ValueSetDefinition.entityReferenceResult" />
		<result property="propertyReference" resultMap="ValueSetDefinition.propertyReferenceResult" />
	</resultMap>
	
	<resultMap  id="codingSchemeReferenceResult" class="codingSchemeReference">
		<result property="codingScheme" column="codingSchemeReference"/>
	</resultMap>
	
	<resultMap  id="valueSetDefinitionReferenceResult" class="valueSetDefinitionReference">
		<result property="valueSetDefinitionURI" column="valueSetDefReference"/>
	</resultMap>
	
	<resultMap  id="entityReferenceResult" class="entityReference">
		<result property="entityCode" column="entityCode"/>
		<result property="entityCodeNamespace" column="entityCodeNamespace"/>
		<result property="leafOnly" column="leafOnly"/>
		<result property="referenceAssociation" column="referenceAssociation"/>
		<result property="targetToSource" column="targetToSource"/>
		<result property="transitiveClosure" column="transitiveClosure"/>
	</resultMap>
	
	<resultMap  id="propertyReferenceResult" class="propertyReference">
		<result property="codingScheme" column="propertyRefCodingScheme"/>
		<result property="propertyName" column="propertyName"/>
		<result property="propertyMatchValue" resultMap="ValueSetDefinition.propertyMatchValueResult"/>
	</resultMap>
	
	<resultMap  id="propertyMatchValueResult" class="propertyMatchValue">
		<result property="matchAlgorithm" column="matchAlgorithm"/>		
		<result property="content" column="propertyMatchValue" />
		<result property="dataType" column="format" />
	</resultMap>
	
	<select id="getValueSetDefinitionURIs" 
		parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter" resultClass="string">
		SELECT
			valueSetDefURI
		FROM
			$prefix$valueSetDefinition
	</select>
	
	<select id="getValueSetDefinitionGuidByValueSetDefinitionURI" 
		parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter" 
		resultClass="string">
		SELECT
			valueSetDefGuid
		FROM
			$prefix$valueSetDefinition
		WHERE
			valueSetDefURI = #param1#
	</select>
	
	<select id="getValueSetDefinitionByValueSetURI" 
		resultMap="valueSetDefinitionResult" 
		parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter">
		SELECT
			valueSetDefURI,
			valueSetDefName,
			defaultCodingScheme,
			conceptDomain,
			description,
			isActive,
			owner,
			status,
			effectiveDate,
			expirationDate
		FROM
			$prefix$valueSetDefinition
		WHERE
			valueSetDefURI = #param1#
	</select>
	
	<select id="getValueSetDefinitionMetaDataByValueSetURI" 
		resultMap="valueSetDefinitionMetaDataResult" 
		parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter">
		SELECT *
		FROM
			$prefix$valueSetDefinition
		WHERE
			valueSetDefURI = #param1#
	</select>
	
	<select id="getValueSetDefinitionURIForValueSetName" 
		resultClass="string" 
		parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter">
		SELECT
			valueSetDefURI
		FROM
			$prefix$valueSetDefinition
		WHERE
			valueSetDefName = #param1#
	</select>
	
	<select id="getDefinitionEntryByValueSetGuid" 
		resultMap="definitionEntryResult" 
		parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter">
		SELECT
			ruleOrder,
			operator,
			codingSchemeReference,
			valueSetDefReference,
			entityCode,
			entityCodeNamespace,
			leafOnly,
			referenceAssociation,
			targetToSource,
			transitiveClosure,
			propertyRefCodingScheme,
			propertyName,
			propertyMatchValue,
			matchAlgorithm,
			format,
			isActive,
			owner,
			status,
			effectiveDate,
			expirationDate,
			entryStateGuid
		FROM
			$prefix$vsdEntry
		WHERE
			valueSetDefGuid = #param1#
		ORDER BY
			ruleOrder
	</select>
	
	<insert id="insertValueSetDefinition" 
		parameterClass="org.lexevs.dao.database.ibatis.valuesets.parameter.InsertValueSetDefinitionBean">
		INSERT INTO $prefix$valueSetDefinition
		(
				valueSetDefGuid,
				valueSetDefURI,
				valueSetDefName,
				defaultCodingScheme,
				conceptDomain,
				description,
				releaseGuid,
				isActive,
				owner,
				status,
				effectiveDate,
				expirationDate,
				entryStateGuid
			) VALUES (
				#uid#,
				#valueSetDefinition.valueSetDefinitionURI#,
				#valueSetDefinition.valueSetDefinitionName#,
				#valueSetDefinition.defaultCodingScheme#,
				#valueSetDefinition.conceptDomain#,
				#valueSetDefinition.entityDescription.content#,
				#systemReleaseUId#,
				#valueSetDefinition.isActive#,
				#valueSetDefinition.owner#,
				#valueSetDefinition.status#,
				#valueSetDefinition.effectiveDate#,
				#valueSetDefinition.expirationDate#,
				#entryStateUId#	
			)
     </insert>

	<update id="updateValueSetDefinitionByUId" parameterClass="org.lexevs.dao.database.ibatis.valuesets.parameter.InsertValueSetDefinitionBean">
		UPDATE 
			$prefix$valueSetDefinition vsDef
		SET 
   		  <dynamic prepend=" ">
			<isNotNull prepend="," property="valueSetDefinition.valueSetDefinitionName">
				valueSetDefName = #valueSetDefinition.valueSetDefinitionName#
			</isNotNull>
			<isNotNull prepend="," property="valueSetDefinition.defaultCodingScheme">
				defaultCodingScheme = #valueSetDefinition.defaultCodingScheme#
			</isNotNull>
			<isNotNull prepend="," property="valueSetDefinition.conceptDomain">
				conceptDomain = #valueSetDefinition.conceptDomain#
			</isNotNull>
			<isNotNull prepend="," property="valueSetDefinition.entityDescription">
				description = #valueSetDefinition.entityDescription.content#
			</isNotNull>			
			<isNotNull prepend="," property="entryStateUId">
				entryStateGuid = #entryStateUId#
			</isNotNull>
		</dynamic>

		WHERE 
			valueSetDefGuid = #uid#
 	</update>	

	<update id="updateValueSetDefVersionableChangesByUId" parameterClass="org.lexevs.dao.database.ibatis.valuesets.parameter.InsertValueSetDefinitionBean">
		UPDATE 
			$prefix$valueSetDefinition vsDef
		SET 
   		  <dynamic prepend=" ">
			<isNotNull prepend="," property="valueSetDefinition.isActive">
				isActive = #valueSetDefinition.isActive#
			</isNotNull>
			<isNotNull prepend="," property="valueSetDefinition.owner">
				owner = #valueSetDefinition.owner#
			</isNotNull>
			<isNotNull prepend="," property="valueSetDefinition.status">
				status = #valueSetDefinition.status#
			</isNotNull>
			<isNotNull prepend="," property="valueSetDefinition.effectiveDate">
				effectiveDate = #valueSetDefinition.effectiveDate#
			</isNotNull>		
			<isNotNull prepend="," property="valueSetDefinition.expirationDate">
				expirationDate = #valueSetDefinition.expirationDate#
			</isNotNull>				
			<isNotNull prepend="," property="entryStateUId">
				entryStateGuid = #entryStateUId#
			</isNotNull>
		</dynamic>

		WHERE 
			vsDef.valueSetDefGuid = #uid#
 	</update> 	
 	
	<update id="updateValueSetDefinitinEntryStateUId" parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameterTuple">
		UPDATE 
			$prefix$valueSetDefinition vsDef
		SET 
			entryStateGuid = #param2#
		WHERE 
			vsDef.valueSetDefGuid = #param1#
 	</update> 	
 	
	<delete id="removevalueSetDefinitionByValueSetDefinitionURI" parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter">
		DELETE FROM
			$prefix$valueSetDefinition
		WHERE
			valueSetDefURI = #param1#
	</delete>
	
	<delete id="removeDefinitionEntryByValueSetDefinitionGuid" parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter">
		DELETE FROM
			$prefix$vsdEntry
		WHERE
			valueSetDefGuid = #param1#
	</delete>
	
	<select id="getValueSetDefinitionMetadataByUId" 		
		parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter"
		resultMap="ValueSetDefinition.valueSetDefinitionMetaDataResult">
		SELECT
			vs.valueSetDefGuid,
			vs.valueSetDefURI,
			vs.valueSetDefName,
			vs.defaultCodingScheme,
			vs.conceptDomain,
			vs.description,
			vs.releaseGuid,
			vs.isActive,
			vs.owner,
			vs.status,
			vs.effectiveDate,
			vs.expirationDate,
			vs.entryStateGuid,
			vsMulti.vsMultiAttribGuid,
			vsMulti.referenceGuid,
			vsMulti.referenceType,
			vsMulti.attributeType,
			vsMulti.attributeValue,
			vsMulti.subRef,
			vsMulti.role,
			vsMulti.entryStateGuid esGuid				
		FROM
			$prefix$valueSetDefinition vs
		LEFT JOIN
			$prefix$vsMultiAttrib vsMulti
		ON
			vsMulti.referenceGuid = vs.valueSetDefGuid
		WHERE
			valueSetDefGuid = #param1#
	</select>

	<select id="getEntryStateUIdByValuesetDefUId" 
		resultClass="string" 
		parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter">
		SELECT
			entryStateGuid
		FROM
			$prefix$valueSetDefinition
		WHERE
			valueSetDefGuid = #param1#
	</select>
	
	<select id="getValueSetDefinitionLatestRevisionIdByUId" remapResults="true"
		parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter"
		resultClass="string">
		SELECT 
			rev.revisionId
		FROM
			$prefix$valueSetDefinition vsDef,
			$prefix$vsEntryState es,
			${defaultPrefix}revision rev
		WHERE
			vsDef.valueSetDefGuid = #param1#	
		AND
			vsDef.entryStateGuid = es.entryStateGuid	
		AND
			es.revisionGuid = rev.revisionGuid	
	</select>  	
</sqlMap>