<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL MAP 2.0//EN" 
	"http://www.ibatis.com/dtd/sql-map-2.dtd">
<sqlMap namespace="Association">

	<typeAlias alias="node" type="org.lexevs.dao.database.access.association.model.Node"/>
	<typeAlias alias="triple" type="org.lexevs.dao.database.access.association.model.Triple"/>
	<typeAlias alias="associatedConcept" type="org.lexevs.dao.database.ibatis.codednodegraph.model.EntityReferencingAssociatedConcept"/>
	<typeAlias alias="associationQualification" type="org.LexGrid.LexBIG.DataModel.Core.NameAndValue"/>
	<typeAlias alias="associationTarget" type="org.lexevs.dao.database.ibatis.association.parameter.InsertOrUpdateAssociationTargetBean"/>
	<typeAlias alias="countConceptReference" type="org.lexevs.dao.database.service.codednodegraph.model.CountConceptReference"/>
	
	<resultMap id="countConceptReferenceResult" class="countConceptReference">
		<result property="code" column="entityCode" />
		<result property="codeNamespace" column="entityCodeNamespace" />
		<result property="childCount" column="relationshipsCount" />
	</resultMap>
	
	<resultMap id="nodeResult" class="node">
		<result property="entityCode" column="entityCode" />
		<result property="entityCodeNamespace" column="entityCodeNamespace" />
	</resultMap>
	
	<resultMap id="countResult" class="java.util.HashMap">
		<result property="key" column="associationName" />
		<result property="value" column="relationshipsCount" javaType="int" />
	</resultMap>
	
	<resultMap id="tripleResult" class="triple">
		<result property="sourceEntityCode" column="sourceEntityCode" />
		<result property="sourceEntityNamespace" column="sourceEntityCodeNamespace" />
		<result property="targetEntityCode" column="targetEntityCode" />
		<result property="targetEntityNamespace" column="targetEntityCodeNamespace" />
		<result property="associationPredicateId" column="associationPredicateGuid" />
	</resultMap>
	
	<resultMap id="associatedConceptResult" class="associatedConcept" groupBy="guid">
		<result property="guid" column="entityAssnsGuid" typeHandler="variablePrimaryKeyTypeHandler"/>
		<result property="entityGuid" column="entityGuid" typeHandler="variablePrimaryKeyTypeHandler"/>
		<result property="code" column="entityCode" />
		<result property="codeNamespace" column="entityCodeNamespace" />
		<result property="entityDescription.content" column="description" />
		<result property="codingSchemeURI" column="codingSchemeURI" />
<!--		<result property="codingSchemeVersion" column="representsVersion" />-->
		<result property="codingSchemeName" column="codingSchemeName" />
		<result property="associationQualification" resultMap="Association.associationQualificationResult"/>
	</resultMap>

	<resultMap id="associationQualificationResult" class="associationQualification">
		<result property="name" column="qualifierName" />
		<result property="content" column="qualifierValue" />
	</resultMap>
	
	<resultMap id="associationTargetEntry" class="associationTarget" groupBy="uid">
		<result property="uid" column="entityAssnsGuid" typeHandler="variablePrimaryKeyTypeHandler"/>
		<result property="associationPredicateUId" column="associationPredicateGuid" />
		<result property="associationSource.sourceEntityCode" column="sourceEntityCode" />
		<result property="associationSource.sourceEntityCodeNamespace" column="sourceEntityCodeNamespace" />
		<result property="associationTarget.targetEntityCode" column="targetEntityCode" />
		<result property="associationTarget.targetEntityCodeNamespace" column="targetEntityCodeNamespace" />
		<result property="associationTarget.associationInstanceId" column="associationInstanceId" />
		<result property="associationTarget.isDefining" column="isDefining" typeHandler="numericBooleanTypeHandler"/>
		<result property="associationTarget.isInferred" column="isInferred" typeHandler="numericBooleanTypeHandler"/>
		<result property="associationTarget.isActive" column="isActive" typeHandler="numericBooleanTypeHandler"/>
		<result property="associationTarget.owner" column="owner" />
		<result property="associationTarget.status" column="status" />
		<result property="associationTarget.effectiveDate" column="effectiveDate" />
		<result property="associationTarget.expirationDate" column="expirationDate" />
		<result property="entryStateUId" column="entryStateGuid" typeHandler="variablePrimaryKeyTypeHandler"/>
		<result property="assnQualsAndUsageContextList" resultMap="Association.qualContextResult"/>
	</resultMap>
	
	<resultMap id="associationSourceTripleEntry" class="org.LexGrid.relations.AssociationSource" 
		groupBy="sourceEntityCode,sourceEntityCodeNamespace">
		<result property="sourceEntityCode" column="sourceEntityCode" />
		<result property="sourceEntityCodeNamespace" column="sourceEntityCodeNamespace" />
		<result property="_targetList" resultMap="Association.associationTargetTripleEntry"/>
	</resultMap>
	
	<resultMap id="associationTargetTripleEntry" class="org.LexGrid.relations.AssociationTarget" groupBy="associationInstanceId">
		<result property="targetEntityCode" column="targetEntityCode" />
		<result property="targetEntityCodeNamespace" column="targetEntityCodeNamespace" />
		<result property="associationInstanceId" column="associationInstanceId" />
		<result property="isDefining" column="isDefining" typeHandler="numericBooleanTypeHandler"/>
		<result property="isInferred" column="isInferred" typeHandler="numericBooleanTypeHandler"/>
		<result property="isActive" column="isActive" typeHandler="numericBooleanTypeHandler"/>
		<result property="owner" column="owner" />
		<result property="status" column="status" />
		<result property="effectiveDate" column="effectiveDate" />
		<result property="expirationDate" column="expirationDate" />
	</resultMap>

	<select id="getConceptReferenceFromEntityAssnsToEntityUid" 
		parameterClass="org.lexevs.dao.database.ibatis.parameter.SequentialMappedParameterBean"
		remapResults="true" 
		resultMap="Entity.conceptReferenceResult">
		SELECT

			<isEqual property="param1" compareValue="SUBJECT">
				eate.sourceEntityCode as entityCode,
				eate.sourceEntityCodeNamespace as entityCodeNamespace
			</isEqual>
			<isEqual property="param1" compareValue="OBJECT">
				eate.targetEntityCode as entityCode,
				eate.targetEntityCodeNamespace as entityCodeNamespace
			</isEqual>
			
		FROM
			$prefix$entityAssnsToEntity eate
		
		WHERE
			eate.entityAssnsGuid IN ( <iterate property="param2" conjunction=",">#param2[],handler=variablePrimaryKeyTypeHandler#</iterate> )
	</select>
	
	<select id="getNodesPath"
		parameterClass="org.lexevs.dao.database.ibatis.association.parameter.GetNodesPathBean"
		remapResults="true" resultClass="string">
		SELECT 
			tr.path
		FROM 
			$prefix$entityAssnsToEntityTr tr
		WHERE
			tr.sourceEntityCode = #sourceEntityCode# 
			AND 
			tr.sourceEntityCodeNamespace = #sourceEntityCodeNamespace# 
			AND
			tr.targetEntityCode = #targetEntityCode# 
			AND
			tr.targetEntityCodeNamespace = #targetEntityCodeNamespace#
			<isNotNull property="associationPredicateUId">
			AND
			tr.associationPredicateGuid = #associationPredicateUId# 
			</isNotNull>
	</select>
	
	
	<select id="getAssociatedConcpetFromEntityAssnsToEntityUid" 
		parameterClass="org.lexevs.dao.database.ibatis.parameter.SequentialMappedParameterBean"
		remapResults="true" resultMap="Association.associatedConceptResult">
		SELECT
			eate.entityAssnsGuid,
			entity.entityGuid,
			entity.description,
			codingScheme.codingSchemeURI,
			codingScheme.representsVersion,
			codingScheme.codingSchemeName,
			<isEqual property="param1" compareValue="SUBJECT">
				eate.sourceEntityCode as entityCode,
				eate.sourceEntityCodeNamespace as entityCodeNamespace,
			</isEqual>
			<isEqual property="param1" compareValue="OBJECT">
				eate.targetEntityCode as entityCode,
				eate.targetEntityCodeNamespace as entityCodeNamespace,
			</isEqual>
			quals.qualifierName,
			quals.qualifierValue
		FROM
			$prefix$entityAssnsToEntity eate
		LEFT JOIN
			$prefix$entity entity
		ON (
			<isEqual property="param1" compareValue="SUBJECT">
				eate.sourceEntityCode = entity.entityCode
				AND
				eate.sourceEntityCodeNamespace = entity.entityCodeNamespace
			</isEqual>
			<isEqual property="param1" compareValue="OBJECT">
				eate.targetEntityCode = entity.entityCode
				AND
				eate.targetEntityCodeNamespace = entity.entityCodeNamespace
			</isEqual>
			)
		LEFT JOIN
			$prefix$codingScheme codingScheme
		ON (entity.codingSchemeGuid = codingScheme.codingSchemeGuid)
		
		LEFT JOIN
			$prefix$entityAssnQuals quals
		ON (eate.entityAssnsGuid = quals.referenceGuid)
		
		WHERE
			eate.entityAssnsGuid IN ( <iterate property="param2" conjunction=",">#param2[],handler=variablePrimaryKeyTypeHandler#</iterate> )
			
		<isNotEmpty property="param3">
			ORDER BY
			<iterate property="param3" conjunction=",">
				<isEqual property="param1" compareValue="SUBJECT">
					$param3[].columnSortType.objectColumn$
				</isEqual>
				<isEqual property="param1" compareValue="OBJECT">
					$param3[].columnSortType.subjectColumn$
				</isEqual>
				$param3[].order$
			</iterate>
		</isNotEmpty>
	</select>

	<select id="getAccociationInstanceKey" remapResults="true" resultClass="string">
		SELECT
			eae.entityAssnsGuid
		FROM 
			$prefix$entityAssnsToEntity eae
		JOIN
			$prefix$associationPredicate ap
		ON 
			eae.associationPredicateGuid =
			ap.associationPredicateGuid
		JOIN
			$prefix$relation rel
		ON
			ap.relationGuid =
			rel.relationGuid
		WHERE
			rel.codingSchemeGuid = 
			#param1,handler=variablePrimaryKeyTypeHandler#
		AND
			eae.associationInstanceId = 
			#param2,handler=variablePrimaryKeyTypeHandler#
	</select>
	
	<select id="getAllTriplesOfCodingScheme" remapResults="true"
		parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameterTuple" resultMap="Association.tripleResult">
		SELECT
			eae.sourceEntityCode,
			eae.sourceEntityCodeNamespace,
			eae.targetEntityCode,
			eae.targetEntityCodeNamespace,
			eae.associationPredicateGuid
		FROM 
			$prefix$entityAssnsToEntity eae
		JOIN
			$prefix$associationPredicate ap
		ON 
			eae.associationPredicateGuid =
			ap.associationPredicateGuid
		JOIN
			$prefix$relation rel
		ON
			ap.relationGuid =
			rel.relationGuid
		WHERE
			rel.codingSchemeGuid = 
			#param1,handler=variablePrimaryKeyTypeHandler#
		AND
			eae.associationPredicateGuid =
			#param2,handler=variablePrimaryKeyTypeHandler#	
	</select>
	
     <insert id="insertEntityAssnsToEntity" parameterClass="org.lexevs.dao.database.ibatis.association.parameter.InsertOrUpdateAssociationTargetBean">
		INSERT INTO $prefix$entityAssnsToEntity (
			entityAssnsGuid,
			associationPredicateGuid,
			sourceEntityCode,
			sourceEntityCodeNamespace,
			targetEntityCode,
			targetEntityCodeNamespace,
			associationInstanceId,
			isDefining,
			isInferred,
			isActive,
			owner,
			status,
			effectiveDate,
			expirationDate,
			entryStateGuid
		) VALUES (
			#uid,handler=variablePrimaryKeyTypeHandler#, 
			#associationPredicateUId,handler=variablePrimaryKeyTypeHandler#,
			#associationSource.sourceEntityCode#, 
			#associationSource.sourceEntityCodeNamespace#, 
			#associationTarget.targetEntityCode#, 
			#associationTarget.targetEntityCodeNamespace#, 
			#associationTarget.associationInstanceId:VARCHAR#, 
			#associationTarget.isDefining,handler=numericBooleanTypeHandler#,
			#associationTarget.isInferred,handler=numericBooleanTypeHandler#,
			#associationTarget.isActive,handler=numericBooleanTypeHandler#,
			#associationTarget.owner:VARCHAR#,
			#associationTarget.status:VARCHAR#,
			#associationTarget.effectiveDate:TIMESTAMP#,
			#associationTarget.expirationDate:TIMESTAMP#,
			#entryStateUId,handler=variablePrimaryKeyTypeHandler#
		)
  </insert>
  
   <insert id="insertTransitiveClosure" parameterClass="org.lexevs.dao.database.ibatis.association.parameter.InsertTransitiveClosureBean">
		INSERT INTO $prefix$entityAssnsToEntityTr (
			entityAssnsTrGuid,
			associationPredicateGuid,
			sourceEntityCode,
			sourceEntityCodeNamespace,
			targetEntityCode,
			targetEntityCodeNamespace,
			path
		) VALUES (
			#uid,handler=variablePrimaryKeyTypeHandler#, 
			#associationPredicateUId,handler=variablePrimaryKeyTypeHandler#,
			#sourceEntityCode#, 
			#sourceEntityCodeNamespace#, 
			#targetEntityCode#, 
			#targetEntityCodeNamespace#,
			#path#
		)
  </insert>

	<sql id="getEntityAssnsToEntityUidsFragment">
		FROM
			$prefix$entityAssnsToEntity eate
		INNER JOIN
			$prefix$associationPredicate ap
		ON
			(ap.associationPredicateGuid = eate.associationPredicateGuid)
		INNER JOIN
			$prefix$relation rel
		ON
			(rel.relationGuid = ap.relationGuid)
		LEFT JOIN
			$prefix$entityAssnQuals quals
		ON
			(eate.entityAssnsGuid = quals.referenceGuid)
			
		<isEqual property="needsEntityJoin" compareValue="true">
		LEFT JOIN
			$prefix$entity entity
		ON
			(
			<isEqual property="tripleNode" compareValue="SUBJECT">
				eate.targetEntityCode = entity.entityCode
				AND
				eate.targetEntityCodeNamespace = entity.entityCodeNamespace
			</isEqual>
			<isEqual property="tripleNode" compareValue="OBJECT">
				eate.sourceEntityCode = entity.entityCode
				AND
				eate.sourceEntityCodeNamespace = entity.entityCodeNamespace
			</isEqual>
			)
		LEFT JOIN
			$prefix$entityType entityType
		ON
			(entity.entityGuid = entityType.entityGuid)
		</isEqual>
			
		WHERE
			rel.codingSchemeGuid = #codingSchemeUid,handler=variablePrimaryKeyTypeHandler#
			
		<isPropertyAvailable property="relationsContainerName" prepend="AND">
			<isNotNull property="relationsContainerName">
			rel.containerName = #relationsContainerName#
			</isNotNull>
		</isPropertyAvailable>

		<isPropertyAvailable property="associationPredicateUid">
			<isNotNull property="associationPredicateUid" prepend="AND">
			ap.associationPredicateGuid = #associationPredicateUid,handler=variablePrimaryKeyTypeHandler#
			</isNotNull>
		</isPropertyAvailable>

		<isNotEmpty property="associationQualifiers" prepend="AND">
			(
			<iterate property="associationQualifiers" conjunction="AND">
				(
				quals.qualifierName = #associationQualifiers[].qualifierName#
				<isNotEmpty property="associationQualifiers[].qualifierValue">
					AND
					quals.qualifierValue = #associationQualifiers[].qualifierValue#
			</isNotEmpty>
				)
			</iterate>
			)
		</isNotEmpty>

		<isNotEmpty property="associations" prepend="AND">
			(
			<iterate property="associations" conjunction="OR">
				ap.associationName = #associations[]#
			</iterate>
			)
		</isNotEmpty>

		<isNotEmpty property="mustHaveCodes" prepend="AND">
			(
			<iterate property="mustHaveCodes" conjunction="OR">
				<isEqual property="tripleNode" compareValue="SUBJECT">
					(
					eate.targetEntityCode = #mustHaveCodes[].code#
					<isNotNull property="mustHaveCodes[].namespace" prepend="AND">
						eate.targetEntityCodeNamespace = #mustHaveCodes[].namespace#
					</isNotNull>
					)
				</isEqual>
				<isEqual property="tripleNode" compareValue="OBJECT">
					(
					eate.sourceEntityCode = #mustHaveCodes[].code#
					<isNotNull property="mustHaveCodes[].namespace" prepend="AND">
						eate.sourceEntityCodeNamespace = #mustHaveCodes[].namespace#
					</isNotNull>
					)
				</isEqual>
			</iterate>
			)
		</isNotEmpty>
		<isNotEmpty property="mustHaveNamespaces" prepend="AND">
			(
			<iterate property="mustHaveNamespaces" conjunction="OR">
				<isEqual property="tripleNode" compareValue="SUBJECT">
					(
					eate.targetEntityCodeNamespace = #mustHaveNamespaces[]#
					)
				</isEqual>
				<isEqual property="tripleNode" compareValue="OBJECT">
					(
					eate.sourceEntityCodeNamespace = #mustHaveNamespaces[]#
					)
				</isEqual>
			</iterate>
			)
		</isNotEmpty>
		<isNotEmpty property="mustHaveEntityTypes" prepend="AND">
			(
			<iterate property="mustHaveEntityTypes" conjunction="OR">
				entityType.entityType = #mustHaveEntityTypes[]#
			</iterate>
			)
		</isNotEmpty>
		<isNotNull property="restrictToAnonymous" prepend="AND">
			entity.isAnonymous = #restrictToAnonymous,handler=numericBooleanTypeHandler#
		</isNotNull>
	</sql>
	
	<sql id="restrictEntityAssnsToEntityUidsBySingleCodeFragment">
		
		<isEqual property="tripleNode" compareValue="SUBJECT" prepend="AND">
			eate.sourceEntityCode = #entityCode#
			<isNotNull property="entityCodeNamespace" prepend="AND">
				eate.sourceEntityCodeNamespace = #entityCodeNamespace#
			</isNotNull>
		</isEqual>
		<isEqual property="tripleNode" compareValue="OBJECT" prepend="AND">
			eate.targetEntityCode = #entityCode#
			<isNotNull property="entityCodeNamespace" prepend="AND">
				eate.targetEntityCodeNamespace = #entityCodeNamespace#
			</isNotNull>
		</isEqual>
		
	</sql>
	
	<sql id="restrictEntityAssnsToEntityUidsByMultipleCodesFragment">
	
		<isEqual property="tripleNode" compareValue="SUBJECT" prepend="AND">
			(
			<iterate property="conceptReferences" conjunction="OR">
				(	
				eate.sourceEntityCode = #conceptReferences[].code#
				<isNotNull property="conceptReferences[].codeNamespace" prepend="AND">
					eate.sourceEntityCodeNamespace = #conceptReferences[].codeNamespace#
				</isNotNull>
				)
			</iterate>
			)
		</isEqual>
		<isEqual property="tripleNode" compareValue="OBJECT" prepend="AND">
			(
			<iterate property="conceptReferences" conjunction="OR">
				(
				eate.targetEntityCode = #conceptReferences[].code#
				<isNotNull property="conceptReferences[].codeNamespace" prepend="AND">
					eate.targetEntityCodeNamespace = #conceptReferences[].codeNamespace#
				</isNotNull>
				)
			</iterate>
			)
		</isEqual>
	
	</sql>
	
	<sql id="getRelationshipsFragment">
		INNER JOIN
			$prefix$associationPredicate ap
		ON
			(ap.associationPredicateGuid = eate.associationPredicateGuid)
		INNER JOIN
			$prefix$relation rel
		ON
			(rel.relationGuid = ap.relationGuid)
			
		<isEqual property="needsEntityJoin" compareValue="true">
		LEFT JOIN
			$prefix$entity sourceEntity
		ON
			(
				eate.sourceEntityCode = sourceEntity.entityCode
				AND
				eate.sourceEntityCodeNamespace = sourceEntity.entityCodeNamespace
			)
		LEFT JOIN
			$prefix$entityType sourceEntityType
		ON
			(sourceEntity.entityGuid = sourceEntityType.entityGuid)

		LEFT JOIN
			$prefix$entity targetEntity
		ON
			(
				eate.targetEntityCode = targetEntity.entityCode
				AND
				eate.targetEntityCodeNamespace = targetEntity.entityCodeNamespace
			)
		LEFT JOIN
			$prefix$entityType targetEntityType
		ON
			(targetEntity.entityGuid = targetEntityType.entityGuid)
		</isEqual>
		
		WHERE
			rel.codingSchemeGuid = #codingSchemeUid,handler=variablePrimaryKeyTypeHandler#

		<isNotNull property="relationsContainerName" prepend="AND">
			rel.containerName = #relationsContainerName#
		</isNotNull>
		
		<isNotEmpty property="associations" prepend="AND">
			(
			<iterate property="associations" conjunction="OR">
				ap.associationName = #associations[]#
			</iterate>
			)
		</isNotEmpty>

		<isNotNull property="sourceCode" prepend="AND">
			eate.sourceEntityCode = #sourceCode#
		</isNotNull>
		<isNotNull property="sourceNamespace" prepend="AND">
			eate.sourceEntityCodeNamespace = #sourceNamespace#
		</isNotNull>
		<isNotNull property="targetCode" prepend="AND">
			eate.targetEntityCode = #targetCode#
		</isNotNull>
		<isNotNull property="targetNamespace" prepend="AND">
			eate.targetEntityCodeNamespace = #targetNamespace#
		</isNotNull>
		
		<isNotEmpty property="mustHaveSourceCodes" prepend="AND">
			(
			<iterate property="mustHaveSourceCodes" conjunction="OR">
				(
					eate.sourceEntityCode = #mustHaveSourceCodes[].code#
					<isNotEmpty property="mustHaveSourceCodes[].namespace" prepend="AND">
						eate.sourceEntityCodeNamespace = #mustHaveSourceCodes[].namespace#
					</isNotEmpty>
				)
			</iterate>
			)
		</isNotEmpty>
		
		<isNotEmpty property="mustHaveTargetCodes" prepend="AND">
			(
			<iterate property="mustHaveTargetCodes" conjunction="OR">
				(
					eate.targetEntityCode = #mustHaveTargetCodes[].code#
					<isNotEmpty property="mustHaveTargetCodes[].namespace" prepend="AND">
						eate.targetEntityCodeNamespace = #mustHaveTargetCodes[].namespace#
					</isNotEmpty>
				)
			</iterate>
			)
		</isNotEmpty>
		<isNotEmpty property="mustHaveSourceNamespaces" prepend="AND">
			(
			<iterate property="mustHaveSourceNamespaces" conjunction="OR">
					(
					eate.sourceEntityCodeNamespace = #mustHaveSourceNamespaces[]#
					)
			</iterate>
			)
		</isNotEmpty>
		<isNotEmpty property="mustHaveTargetNamespaces" prepend="AND">
			(
			<iterate property="mustHaveTargetNamespaces" conjunction="OR">
					(
					eate.targetEntityCodeNamespace = #mustHaveTargetNamespaces[]#
					)
			</iterate>
			)
		</isNotEmpty>
		
		<isNotEmpty property="mustHaveEntityTypes" prepend="AND">
			(
				(
				<iterate property="mustHaveEntityTypes" conjunction="OR">
					sourceEntityType.entityType = #mustHaveEntityTypes[]#
				</iterate>
				)
				AND
				(
				<iterate property="mustHaveEntityTypes" conjunction="OR">
					targetEntityType.entityType = #mustHaveEntityTypes[]#
				</iterate>
				)	
			)
		</isNotEmpty>
	
		<isNotNull property="restrictToAnonymous" prepend="AND">
			(
			
			sourceEntity.isAnonymous = #restrictToAnonymous,handler=numericBooleanTypeHandler#
			AND
			targetEntity.isAnonymous = #restrictToAnonymous,handler=numericBooleanTypeHandler#
			
			)
		</isNotNull>
	</sql>
	
	<sql id="getEntityAssnsToEntityRelationships">
		SELECT DISTINCT
			eate.associationPredicateGuid
		FROM
			$prefix$entityAssnsToEntity eate
		LEFT JOIN
			$prefix$entityAssnQuals quals
		ON
			(eate.entityAssnsGuid = quals.referenceGuid)
		<include refid="getRelationshipsFragment"/>
	
		<isNotEmpty property="associationQualifiers" prepend="AND">
			(
			<iterate property="associationQualifiers" conjunction="AND">
				(
				quals.qualifierName = #associationQualifiers[].qualifierName#
				<isNotEmpty property="associationQualifiers[].qualifierValue">
					AND
					quals.qualifierValue = #associationQualifiers[].qualifierValue#
			</isNotEmpty>
				)
			</iterate>
			)
		</isNotEmpty>

	</sql>
	
	<sql id="getEntityAssnsToEntityTrRelationships">
		SELECT DISTINCT
			eate.associationPredicateGuid
		FROM
			$prefix$entityAssnsToEntityTr eate
		<include refid="getRelationshipsFragment"/>
	</sql>
	
	<select id="getCodeRelationships"
				parameterClass="org.lexevs.dao.database.ibatis.association.parameter.GetCodeRelationshipsBean"
				remapResults="true"
				resultClass="string">
		<include refid="getEntityAssnsToEntityRelationships"/>
	
		<isEqual property="useTransitive" compareValue="true">
			UNION
			<include refid="getEntityAssnsToEntityTrRelationships"/>
		</isEqual>
	</select>
	
	<select id="getAssociationPredicateNameForAssociationInstanceId"
				parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter"
				remapResults="true"
				resultClass="string">
			SELECT 
				ap.associationName
			FROM
				$prefix$entityAssnsToEntity eate
			INNER JOIN
				$prefix$associationPredicate ap
			ON
				eate.associationPredicateGuid = ap.associationPredicateGuid
			WHERE
				eate.associationInstanceId = #param1#
				
			UNION 
			
			SELECT 
				ap.associationName
			FROM
				$prefix$entityAssnsToData eatd
			INNER JOIN
				$prefix$associationPredicate ap
			ON
				eatd.associationPredicateGuid = ap.associationPredicateGuid
			WHERE
				eatd.associationInstanceId = #param1#
	</select>
	
	<select id="getRelationContainerNameForAssociationInstanceId"
				parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter"
				remapResults="true"
				resultClass="string">
			SELECT 
				rel.containerName
			FROM
				$prefix$entityAssnsToEntity eate
			INNER JOIN
				$prefix$associationPredicate ap
			ON
				eate.associationPredicateGuid = ap.associationPredicateGuid
			INNER JOIN 
				$prefix$relation rel
			ON
				ap.relationGuid = rel.relationGuid
			WHERE
				eate.associationInstanceId = #param1#
				
			UNION 
			
			SELECT 
				rel.containerName
			FROM
				$prefix$entityAssnsToData eatd
			INNER JOIN
				$prefix$associationPredicate ap
			ON
				eatd.associationPredicateGuid = ap.associationPredicateGuid
			INNER JOIN 
				$prefix$relation rel
			ON
				ap.relationGuid = rel.relationGuid
			WHERE
				eatd.associationInstanceId = #param1#
	</select>
	
	<select id="getRootEntityAssnsToEntityUids"
				parameterClass="org.lexevs.dao.database.ibatis.parameter.SequentialMappedParameterBean"
				remapResults="true"
				resultMap="Entity.conceptReferenceResult">
		SELECT DISTINCT
			eate1.sourceEntityCode AS entityCode,
			eate1.sourceEntityCodeNamespace AS entityCodeNamespace
		FROM
			$prefix$entityAssnsToEntity eate1

		LEFT JOIN
			<isNotEmpty property="param3">
			(
			</isNotEmpty>
			$prefix$entityAssnsToEntity eate2
			<isNotEmpty property="param3">
			LEFT JOIN 
				$prefix$entityAssnQuals eaq2
			ON
				(eaq2.referenceGuid = eate2.entityAssnsGuid)
			)
			</isNotEmpty>
		ON (
			eate1.sourceEntityCode = eate2.targetEntityCode

			AND
			eate1.sourceEntityCodeNamespace = eate2.TargetEntityCodeNamespace

			<isEqual property="param1" compareValue="INDIVIDUALLY">
			AND
			eate1.associationPredicateGuid = eate2.associationPredicateGuid
			</isEqual>
			
			<isEqual property="param1" compareValue="TOGETHER">
			
				<isNotEmpty property="param2" prepend="AND">
				(
					 <iterate property="param2" conjunction="OR"> eate1.associationPredicateGuid = #param2[],handler=variablePrimaryKeyTypeHandler# </iterate>
				)
				AND
				(
					 <iterate property="param2" conjunction="OR"> eate2.associationPredicateGuid = #param2[],handler=variablePrimaryKeyTypeHandler# </iterate>
				)
				</isNotEmpty>		
			
			</isEqual>
			
			<isNotEmpty property="param3" prepend="AND">
			(
			<iterate property="param3" conjunction="OR"> 
				eaq2.qualifierName = #param3[].qualifierName#
				
				<isNotEmpty property="param3[].qualifierValue" prepend="AND">
					eaq2.qualifierValue = #param3[].qualifierValue#
				</isNotEmpty>
			</iterate>
			)
			</isNotEmpty>
			
<!--			<isNotEmpty property="param4" prepend="AND">-->
<!--			(-->
<!--				<iterate property="param4" conjunction="AND"> -->
<!--					eate1.sourceEntityCodeNamespace != #param4[]#-->
<!--				</iterate>-->
<!--			)-->
<!--			</isNotEmpty>-->
			
			)	
		<isNotEmpty property="param3">
			LEFT JOIN
				$prefix$entityAssnQuals eaq1
			ON
				eate1.entityAssnsGuid = eaq1.referenceGuid
		</isNotEmpty>

		WHERE
			eate2.entityAssnsGuid IS NULL	
			
			<isNotEmpty property="param3" prepend="AND">
			(
			<iterate property="param3" conjunction="OR"> 
				eaq1.qualifierName = #param3[].qualifierName#
				
				<isNotEmpty property="param3[].qualifierValue" prepend="AND">
					eaq1.qualifierValue = #param3[].qualifierValue#
				</isNotEmpty>
			</iterate>
			)
			</isNotEmpty>

			<isNotEmpty property="param2" prepend="AND">
				eate1.associationPredicateGuid IN ( <iterate property="param2" conjunction=",">#param2[],handler=variablePrimaryKeyTypeHandler#</iterate> )
			</isNotEmpty>	
			
			<isNotEmpty property="param4" prepend="AND">
			(
				<iterate property="param4" conjunction="AND"> 
					eate1.sourceEntityCodeNamespace = #param4[]#
				</iterate>
			)
			</isNotEmpty>
			
			<isNotEmpty property="param5" prepend="AND">
			(
				<iterate property="param5" conjunction="AND"> 
					eate1.targetEntityCodeNamespace = #param5[]#
				</iterate>
			)
			</isNotEmpty>
	</select>
	
	<select id="getTailEntityAssnsToEntityUids"
				parameterClass="org.lexevs.dao.database.ibatis.parameter.SequentialMappedParameterBean"
				remapResults="true"
				resultMap="Entity.conceptReferenceResult">
		SELECT DISTINCT
			eate1.targetEntityCode AS entityCode,
			eate1.targetEntityCodeNamespace AS entityCodeNamespace
		FROM
			$prefix$entityAssnsToEntity eate1
		
		LEFT JOIN
			<isNotEmpty property="param3">
			(
			</isNotEmpty>
			$prefix$entityAssnsToEntity eate2
			<isNotEmpty property="param3">
			LEFT JOIN 
				$prefix$entityAssnQuals eaq2
			ON
				(eaq2.referenceGuid = eate2.entityAssnsGuid)
			)
			</isNotEmpty>
		ON (
			eate1.targetEntityCode = eate2.sourceEntityCode
		
			AND
			eate1.targetEntityCodeNamespace = eate2.sourceEntityCodeNamespace
			
			<isEqual property="param1" compareValue="INDIVIDUALLY">
			AND
			eate1.associationPredicateGuid = eate2.associationPredicateGuid
			</isEqual>
			
			<isEqual property="param1" compareValue="TOGETHER">
		
				<isNotEmpty property="param2" prepend="AND">
				(
					 <iterate property="param2" conjunction="OR"> eate1.associationPredicateGuid = #param2[],handler=variablePrimaryKeyTypeHandler# </iterate>
				)
				AND
				(
					 <iterate property="param2" conjunction="OR"> eate2.associationPredicateGuid = #param2[],handler=variablePrimaryKeyTypeHandler# </iterate>
				)
				</isNotEmpty>		
			
			</isEqual>
			
			<isNotEmpty property="param3" prepend="AND">
			(
			<iterate property="param3" conjunction="OR"> 
				eaq2.qualifierName = #param3[].qualifierName#
				
				<isNotEmpty property="param3[].qualifierValue" prepend="AND">
					eaq2.qualifierValue = #param3[].qualifierValue#
				</isNotEmpty>
			</iterate>
			)
			</isNotEmpty>
			
<!--			<isNotEmpty property="param4" prepend="AND">-->
<!--			(-->
<!--				<iterate property="param4" conjunction="AND"> -->
<!--					eate1.sourceEntityCodeNamespace != #param4[]#-->
<!--				</iterate>-->
<!--			)-->
<!--			</isNotEmpty>-->
			)
			
		<isNotEmpty property="param3">
			LEFT JOIN
				$prefix$entityAssnQuals eaq1
			ON
				eate1.entityAssnsGuid = eaq1.referenceGuid
		</isNotEmpty>
		WHERE
			eate2.entityAssnsGuid IS NULL	
			
			<isNotEmpty property="param3" prepend="AND">
			(
			<iterate property="param3" conjunction="OR"> 
				eaq1.qualifierName = #param3[].qualifierName#
				
				<isNotEmpty property="param3[].qualifierValue" prepend="AND">
					eaq1.qualifierValue = #param3[].qualifierValue#
				</isNotEmpty>
			</iterate>
			)
			</isNotEmpty>

			<isNotEmpty property="param2" prepend="AND">
				eate1.associationPredicateGuid IN ( <iterate property="param2" conjunction=",">#param2[],handler=variablePrimaryKeyTypeHandler#</iterate> )
			</isNotEmpty>	
			
			<isNotEmpty property="param4" prepend="AND">
			(
				<iterate property="param4" conjunction="AND"> 
					eate1.sourceEntityCodeNamespace = #param4[]#
				</iterate>
			)
			</isNotEmpty>
			
			<isNotEmpty property="param5" prepend="AND">
			(
				<iterate property="param5" conjunction="AND"> 
					eate1.targetEntityCodeNamespace = #param5[]#
				</iterate>
			)
			</isNotEmpty>
			
	</select>
  
  	<select id="getEntityAssnsToEntityUids"
				parameterClass="org.lexevs.dao.database.ibatis.association.parameter.GetEntityAssnUidsBean"
				remapResults="true"
				resultMap="Common.uidResult">
		SELECT DISTINCT 
			(eate.entityAssnsGuid) AS uidKey
			
		<isNotEmpty property="sorts" prepend=",">
			<iterate property="sorts" conjunction=",">
				<isEqual property="tripleNode" compareValue="SUBJECT">
					$sorts[].columnSortType.subjectColumn$
				</isEqual>
				<isEqual property="tripleNode" compareValue="OBJECT">
					$sorts[].columnSortType.objectColumn$
				</isEqual>
			</iterate>
		</isNotEmpty>
		
		<include refid="getEntityAssnsToEntityUidsFragment"/>
		<include refid="restrictEntityAssnsToEntityUidsBySingleCodeFragment"/>
		
		<isNotEmpty property="sorts">
			ORDER BY
			<iterate property="sorts" conjunction=",">
				<isEqual property="tripleNode" compareValue="SUBJECT">
					$sorts[].columnSortType.subjectColumn$
				</isEqual>
				<isEqual property="tripleNode" compareValue="OBJECT">
					$sorts[].columnSortType.objectColumn$
				</isEqual>
				$sorts[].order$
			</iterate>
		</isNotEmpty>
	</select>
	
	<select id="getEntityAssnsToEntityUidsCount"
				parameterClass="org.lexevs.dao.database.ibatis.association.parameter.GetEntityAssnUidsCountBean"
				resultMap="countResult">
		SELECT 
			COUNT( DISTINCT eate.entityAssnsGuid ) AS relationshipsCount,
			ap.associationName AS associationName
		<include refid="getEntityAssnsToEntityUidsFragment"/>
		<include refid="restrictEntityAssnsToEntityUidsBySingleCodeFragment"/>
		GROUP BY
			associationName
	</select>
	
	<select id="getCountConceptReferences"
				parameterClass="org.lexevs.dao.database.ibatis.association.parameter.GetEntityAssnUidsCountBean"
				resultMap="countConceptReferenceResult">
		SELECT 
			COUNT( DISTINCT eate.entityAssnsGuid ) AS relationshipsCount,
			<isEqual property="tripleNode" compareValue="SUBJECT">
				eate.sourceEntityCode AS entityCode,
				eate.sourceEntityCodeNamespace AS entityCodeNamespace
			</isEqual>
			<isEqual property="tripleNode" compareValue="OBJECT">
				eate.targetEntityCode AS entityCode,
				eate.targetEntityCodeNamespace AS entityCodeNamespace
			</isEqual>
			
		<include refid="getEntityAssnsToEntityUidsFragment"/>
		<include refid="restrictEntityAssnsToEntityUidsByMultipleCodesFragment"/>
		
		AND
			eate.sourceEntityCode NOT IN ('@' , '@@')
		AND
			eate.targetEntityCode NOT IN ('@' , '@@')
		
		GROUP BY
			<isEqual property="tripleNode" compareValue="SUBJECT">
				eate.sourceEntityCode,
				eate.sourceEntityCodeNamespace
			</isEqual>
			<isEqual property="tripleNode" compareValue="OBJECT">
				eate.targetEntityCode,
				eate.targetEntityCodeNamespace
			</isEqual>
	</select>
	
	<select id="getDistinctSources" 
		parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter"
		remapResults="true" 
		resultMap="nodeResult">
		SELECT DISTINCT
			sourceEntityCode AS entityCode,
			sourceEntityCodeNamespace AS entityCodeNamespace
		FROM 
			$prefix$entityAssnsToEntity
		WHERE
			associationPredicateGuid = #param1,handler=variablePrimaryKeyTypeHandler#
	</select>
	
	<select id="getTargetsOfSource" 
		parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameterTriple"
		remapResults="true" 
		resultMap="nodeResult">
		SELECT
			targetEntityCode AS entityCode,
			targetEntityCodeNamespace AS entityCodeNamespace
		FROM 
			$prefix$entityAssnsToEntity
		WHERE
			associationPredicateGuid = #param1,handler=variablePrimaryKeyTypeHandler#
		AND
			sourceEntityCode = #param2#
		AND
			sourceEntityCodeNamespace = #param3#		
	</select>
	
	<select id="getEntryStateUidByAssociationTarget"
		parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter"
		remapResults="true" resultMap="Common.uidResult">
		SELECT 
			eate.entryStateGuid AS uidKey
		FROM
			$prefix$entityAssnsToEntity eate
		WHERE
			eate.entityAssnsGuid = #param1,handler=variablePrimaryKeyTypeHandler# 
	</select>
    
	<select id="getAssnTargetAttributesByUId"
		parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter"
		remapResults="true" resultMap="associationTargetEntry">
		SELECT 
			entAssn.entityAssnsGuid,
			entAssn.associationPredicateGuid,
			entAssn.sourceEntityCode,
			entAssn.sourceEntityCodeNamespace,
			entAssn.targetEntityCode,
			entAssn.targetEntityCodeNamespace,
			entAssn.associationInstanceId,
			entAssn.isDefining,
			entAssn.isInferred,
			entAssn.isActive,
			entAssn.owner,
			entAssn.status,
			entAssn.effectiveDate,
			entAssn.expirationDate,
			entAssn.entryStateGuid,
			quals.entityAssnQualsGuid,
			quals.referenceGuid,
			quals.qualifierName,
			quals.qualifierValue,
			quals.entryStateGuid esGuid
		FROM
			$prefix$entityAssnsToEntity entAssn
		LEFT JOIN
			$prefix$entityAssnQuals quals
		ON
			entAssn.entityAssnsGuid = quals.referenceGuid
		WHERE
			entAssn.entityAssnsGuid = #param1,handler=variablePrimaryKeyTypeHandler# 
			
	</select>
	
	<sql id="getTripleFragment">
		SELECT 
			entAssn.sourceEntityCode,
			entAssn.sourceEntityCodeNamespace,
			entAssn.targetEntityCode,
			entAssn.targetEntityCodeNamespace,
			entAssn.associationInstanceId,
			entAssn.isDefining,
			entAssn.isInferred,
			entAssn.isActive,
			entAssn.owner,
			entAssn.status,
			entAssn.effectiveDate,
			entAssn.expirationDate,
			
			entryState.changeType,
  			entryState.relativeOrder,
  			
  			currentRevision.revisionId AS currentRevisionId,
  			previousRevision.revisionId AS previousRevisionId

		FROM
			$prefix$entityAssnsToEntity entAssn
			
		LEFT JOIN
			$actualTableSetPrefix$entryState entryState
		ON
			entAssn.entryStateGuid =
			entryState.entryStateGuid	
			
		LEFT JOIN
			${defaultPrefix}revision currentRevision
		ON 
			entryState.revisionGuid = currentRevision.revisionGuid
			
		LEFT JOIN
			${defaultPrefix}revision previousRevision
		ON 
			entryState.prevRevisionGuid = previousRevision.revisionGuid	
	</sql>
	
	<select id="getTripleByUid"
		parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter"
		remapResults="true" resultMap="associationSourceTripleEntry">
		<include refid="getTripleFragment"/>
		WHERE
			entAssn.entityAssnsGuid = #param1,handler=variablePrimaryKeyTypeHandler# 	
	</select>
	
	<select id="getHistoryTripleByUidAndRevisionId"
		parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameterTuple"
		remapResults="true" resultMap="associationSourceTripleEntry">
		<include refid="getTripleFragment"/>
		WHERE
			entAssn.entityAssnsGuid = #param1,handler=variablePrimaryKeyTypeHandler# 	
		AND
			currentRevision.revisionId = #param2#		
	</select>

	<update id="updateEntityAssnToEntityByUId"
		parameterClass="org.lexevs.dao.database.ibatis.association.parameter.InsertOrUpdateAssociationTargetBean">
		UPDATE
			$prefix$entityAssnsToEntity
		SET
		<dynamic prepend=" ">
			<isNotNull prepend="," property="associationSource.sourceEntityCode">
				sourceEntityCode = #associationSource.sourceEntityCode#
			</isNotNull>
			<isNotNull prepend="," property="associationSource.sourceEntityCodeNamespace">
				sourceEntityCodeNamespace = #associationSource.sourceEntityCodeNamespace#
			</isNotNull>
			<isNotNull prepend="," property="associationTarget.targetEntityCode">
				targetEntityCode = #associationTarget.targetEntityCode#
			</isNotNull>
			<isNotNull prepend="," property="associationTarget.targetEntityCodeNamespace">
				targetEntityCodeNamespace = #associationTarget.targetEntityCodeNamespace#
			</isNotNull>
			<isNotNull prepend="," property="associationTarget.isDefining">
				isDefining = #associationTarget.isDefining,handler=numericBooleanTypeHandler#
			</isNotNull>
			<isNotNull prepend="," property="associationTarget.isInferred">
				isInferred = #associationTarget.isInferred,handler=numericBooleanTypeHandler#
			</isNotNull>
			<isNotNull prepend="," property="entryStateUId">
				entryStateGuid = #entryStateUId,handler=variablePrimaryKeyTypeHandler#
			</isNotNull>
		</dynamic>
		WHERE
			entityAssnsGuid = #uid,handler=variablePrimaryKeyTypeHandler#
	</update>
	
	<update id="updateEntityAssnToEntityVerAttribByUId"
		parameterClass="org.lexevs.dao.database.ibatis.association.parameter.InsertOrUpdateAssociationTargetBean">
		UPDATE
			$prefix$entityAssnsToEntity
		SET
		<dynamic prepend=" ">
			<isNotNull prepend="," property="associationTarget.isActive">
				isActive =
				#associationTarget.isActive,handler=numericBooleanTypeHandler#
			</isNotNull>
			<isNotNull prepend="," property="associationTarget.owner">
				owner = #associationTarget.owner#
			</isNotNull>
			<isNotNull prepend="," property="associationTarget.status">
				status = #associationTarget.status#
			</isNotNull>
			<isNotNull prepend="," property="associationTarget.effectiveDate">
				effectiveDate =
				#associationTarget.effectiveDate#
			</isNotNull>
			<isNotNull prepend="," property="associationTarget.expirationDate">
				expirationDate =
				#associationTarget.expirationDate#
			</isNotNull>
			<isNotNull prepend="," property="entryStateUId">
				entryStateGuid = #entryStateUId,handler=variablePrimaryKeyTypeHandler#
			</isNotNull>
		</dynamic>
		WHERE
			entityAssnsGuid = #uid,handler=variablePrimaryKeyTypeHandler#
	</update>	
	
	<delete id="deleteAssocTargetByAssnUId" parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter">
		DELETE FROM
			$prefix$entityAssnsToEntity
		WHERE
			entityAssnsGuid = #param1,handler=variablePrimaryKeyTypeHandler#
	</delete>
	
	<select id="getAssociationTargetLatestRevisionIdByUId" remapResults="true"
		parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter"
		resultClass="string">
		SELECT 
			rev.revisionId
		FROM
			$prefix$entityAssnsToEntity entAssnEnt,
			$prefix$entryState es,
			${defaultPrefix}revision rev
		WHERE
			entAssnEnt.entityAssnsGuid = #param1,handler=variablePrimaryKeyTypeHandler#	
		AND
			entAssnEnt.entryStateGuid = es.entryStateGuid	
		AND
			es.revisionGuid = rev.revisionGuid	
	</select> 
</sqlMap>