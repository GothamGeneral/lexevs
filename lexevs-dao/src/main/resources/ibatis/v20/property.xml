<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL MAP 2.0//EN" 
	"http://www.ibatis.com/dtd/sql-map-2.dtd">
<sqlMap namespace="Property">

	<typeAlias alias="property" type="org.LexGrid.commonTypes.Property" />
	<typeAlias alias="presentation" type="org.LexGrid.concepts.Presentation"/>
	<typeAlias alias="definition" type="org.LexGrid.concepts.Definition"/>
	<typeAlias alias="comment" type="org.LexGrid.concepts.Comment"/>

	<resultMap id="propertyResult" class="property" groupBy="propertyId">
		<result property="propertyName" column="propertyName" />	
		<result property="propertyId" column="propertyId" />
		<result property="propertyType" column="propertyType" />
		<result property="language" column="language" />
		<result property="value.content" column="propertyValue" />
		<result property="value.dataType" column="format" />
		<result property="_sourceList" resultMap="Property.sourceResult"/>
		<result property="_propertyQualifierList" resultMap="Property.qualifierResult"/>
		<result property="_usageContextList" resultMap="Property.usageContextResult"/>
		<discriminator javaType="string" column="propertyType">
			<subMap value="presentation" resultMap="presentationResult" />
			<subMap value="definition" resultMap="definitionResult" />
			<subMap value="comment" resultMap="commentResult" />
		</discriminator>	
	</resultMap>
	
	<resultMap id="presentationResult" class="presentation" extends="propertyResult" >
		<result property="isPreferred" column="isPreferred" />
		<result property="degreeOfFidelity" column="degreeOfFidelity"/>
		<result property="matchIfNoContext" column="matchIfNoContext"/>
		<result property="representationalForm" column="representationalForm"/>
	</resultMap>
	
	<resultMap id="definitionResult" class="definition" extends="propertyResult" >
		<result property="isPreferred" column="isPreferred" />
	</resultMap>
	
	<resultMap id="commentResult" class="comment" extends="propertyResult" />
	
	<select id="getPropertyId" resultClass="string" parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameterTuple">
  		SELECT
  			propertyGuid
  		FROM
  			$prefix$property
  		WHERE
			referenceGuid = #param1#
		AND
			propertyId = #param2#
  	</select>
  	
  	<sql id="selectPropertyFragment">
  		SELECT
  			property.referenceType,
  			property.propertyId,
  			property.propertyType,
  			property.propertyName,
  			property.language,
  			property.format,
  			property.isPreferred,
  			property.matchIfNoContext,
  			property.degreeOfFidelity,
  			property.representationalForm,
  			property.propertyValue,
  			entryState.changeType,
  			entryState.relativeOrder,
  			
  			usageContext.attributeId usageContextAttributeId,
  			
  			source.attributeId sourceAttributeId,
  			source.subRef sourceSubRef,
  			source.role sourceRole,
  			
  			qualifier.attributeType qualifierAttributeType,
  			qualifier.attributeId qualifierAttributeId,
  			qualifier.attributeValue qualifierAttributeValue
  			
  		FROM
  			$prefix$property property
  		LEFT JOIN
  			${defaultPrefix}entryState entryState
  		ON
  			property.entryStateGuid =
  			entryState.entryStateGuid	
  	</sql>
  	
  	<sql id="getHistoryPropertyFragment">
  	  	<include refid="selectPropertyFragment"/>
  				
  		LEFT JOIN
  			$prefix$propertyMultiAttrib qualifier
  		ON
  		(
  			property.propertyGuid = qualifier.propertyGuid	
  			AND		
  			qualifier.attributeType = 'qualifier'		
  			AND	
  			qualifier.entryStateGuid = property.entryStateGuid
  		)
  			
  		LEFT JOIN
  			$prefix$propertyMultiAttrib usageContext
  		ON
  		(
  			property.propertyGuid = usageContext.propertyGuid	
  			AND 			
  			usageContext.attributeType = 'usageContext' 			
  			AND 			
  			usageContext.entryStateGuid = property.entryStateGuid
  		)
  			
  		LEFT JOIN
  			$prefix$propertyMultiAttrib source
  		ON
  		(
  			property.propertyGuid = source.propertyGuid		
  			AND	
  			source.attributeType = 'source'	
  			AND	
  			source.entryStateGuid = property.entryStateGuid
  		)		
  	</sql>
  	
  	<sql id="getPropertyFragment">
  	  	<include refid="selectPropertyFragment"/>
  				
  		LEFT JOIN
  			$prefix$propertyMultiAttrib qualifier
  		ON
  		(
  			property.propertyGuid = qualifier.propertyGuid	  			
  			AND 			
  			qualifier.attributeType = 'qualifier'
  		)
  			
  		LEFT JOIN
  			$prefix$propertyMultiAttrib usageContext
  		ON
  		(
  			property.propertyGuid = usageContext.propertyGuid	
  			AND		
  			usageContext.attributeType = 'usageContext'
  		)
  			
  		LEFT JOIN
  			$prefix$propertyMultiAttrib source
  		ON
  		(
  			property.propertyGuid = source.propertyGuid		
  			AND	
  			source.attributeType = 'source'
  		)		
  	</sql>

  	<select id="getPropertiesByParent" resultMap="propertyResult" parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameterTuple">
		<include refid="getPropertyFragment"/>
  		WHERE
			property.referenceType = #param1#
		AND 
			property.referenceGuid = #param2#
  	</select>
  	
  	<select id="getPropertiesByParentAndRevisionId" resultMap="propertyResult" parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameterTriple">
		<include refid="getHistoryPropertyFragment"/>
  		WHERE
			property.referenceType = #param1#
		AND 
			property.referenceGuid = #param2#
		AND 
			entryState.revisionGuid = #param3#
  	</select>

	<delete id="deleteEntityPropertiesByCodingSchemeId" parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameterTuple">
		DELETE FROM
			$prefix$property
		WHERE
			referenceType = #param1#
		AND 
			referenceGuid
		IN	(
			SELECT 
				entityGuid
			FROM
				$prefix$entity
			WHERE
				codingSchemeGuid = #param2#
			)
	</delete>
	
     <insert id="insertProperty" parameterClass="org.lexevs.dao.database.ibatis.property.parameter.InsertOrUpdatePropertyBean">
		INSERT INTO $prefix$property (
			propertyGuid,
			referenceGuid,
			referenceType,
			propertyId,
			propertyType,
			propertyName,
			language,
			format,
			isPreferred,
			matchIfNoContext,
			degreeOfFidelity,
			representationalForm,
			propertyValue,
			isActive,
			owner,
			status,
			effectiveDate,
			expirationDate,
			entryStateGuid
		) VALUES (
			#id#, 
			#entityId#,
			#referenceType#, 
			#property.propertyId#, 
			#property.propertyType#,
			#property.propertyName#,
			#property.language#,
			#property.value.dataType#,
			
			<isPropertyAvailable property="property.isPreferred">
				#property.isPreferred#,
			</isPropertyAvailable>
			<isNotPropertyAvailable property="property.isPreferred">
				null,
			</isNotPropertyAvailable>
			
			<isPropertyAvailable property="property.matchIfNoContext">
				#property.matchIfNoContext#,
			</isPropertyAvailable>
			<isNotPropertyAvailable property="property.matchIfNoContext">
				null,
			</isNotPropertyAvailable>
			
			<isPropertyAvailable property="property.degreeOfFidelity">
				#property.degreeOfFidelity#,
			</isPropertyAvailable>
			<isNotPropertyAvailable property="property.degreeOfFidelity">
				null,
			</isNotPropertyAvailable>
			
			<isPropertyAvailable property="property.representationalForm">
				#property.representationalForm#,
			</isPropertyAvailable>
			<isNotPropertyAvailable property="property.representationalForm">
				null,
			</isNotPropertyAvailable>
			
			#property.value.content#,	
			#property.isActive#,
			#property.owner#,
			#property.status#,
			#property.effectiveDate#,
			#property.expirationDate#,
			#entryStateId#
		)
  </insert>
  
  <update id="updatePropertyById"
  	parameterClass="org.lexevs.dao.database.ibatis.property.parameter.InsertOrUpdatePropertyBean">
  		UPDATE 
			$prefix$property property
		SET 
   		  <dynamic prepend=" ">
   		  	<isNotNull prepend="," property="property.propertyType">
				propertyType = #property.propertyType#
			</isNotNull>
			<isNotNull prepend="," property="property.value.content">
				propertyValue = #property.value.content#
			</isNotNull>
		  </dynamic>
		 WHERE
		 	property.propertyGuid = #id#
  </update>
    
</sqlMap>