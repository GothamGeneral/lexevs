<beans xmlns="http://www.springframework.org/schema/beans"
   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   xmlns:aop="http://www.springframework.org/schema/aop"
   xmlns:tx="http://www.springframework.org/schema/tx"
   xsi:schemaLocation="
   http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
   http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-2.0.xsd
   http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-2.0.xsd">
	
	<import resource="classpath:lexevsCache.xml"/>
	
	 <bean id="entityCompassDao" class="org.lexevs.dao.index.compass.CompassEntityDao">
     	 <property name="compass" ref="compass" />
     	 <property name="compassSearchHelper" ref="compassSearchHelper" />
   	</bean>
  
	 <bean id="sqlMap"
          class="org.springframework.orm.ibatis.SqlMapClientFactoryBean">
       		 <property name="configLocation" value="classpath:ibatis/v20/v20SqlMaps.xml"/>
        <property name="dataSource" ref="dataSource" />
    </bean>   
    
    <bean id="abstractIbatisDao" abstract="true">
    	<property name="sqlMapClientTemplate" ref="sqlMapClientTemplate"/>
		<property name="prefixResolver" ref="defaultPrefixResolver"/>
    </bean>
    

    <bean id="ibatisTableMetadataDao"
		class="org.lexevs.dao.database.ibatis.tablemetadata.IbatisTableMetadataDao">
		<property name="sqlMapClientTemplate" ref="sqlMapClientTemplate"/>
		<property name="prefixResolver" ref="defaultPrefixResolver"/>
	</bean>
	
	<bean id="ibatisPropertyDao"
		class="org.lexevs.dao.database.ibatis.property.IbatisPropertyDao" parent="abstractIbatisDao">
		<property name="ibatisVersionsDao" ref="ibatisVersionsDao"/>
	</bean>
    
    <bean id="ibatisCodingSchemeDao"
		class="org.lexevs.dao.database.ibatis.codingscheme.IbatisCodingSchemeDao" parent="abstractIbatisDao">
		<property name="versionsDao" ref="ibatisVersionsDao"/>
	</bean>
	
	<bean id="daoManager" class="org.lexevs.dao.database.access.DaoManager">
		<property name="codingSchemeDaos">
			<list>
				<ref bean="ibatisCodingSchemeDao"/>
			</list>
		</property>
		<property name="entityDaos">
			<list>
				<ref bean="ibatisEntityDao"/>
			</list>
		</property>
		<property name="registry" ref="databaseRegistry"/>
	</bean>
	
	 <bean id="ibatisEntityDao"
		class="org.lexevs.dao.database.ibatis.entity.IbatisEntityDao" parent="abstractIbatisDao">
		<property name="ibatisVersionsDao" ref="ibatisVersionsDao"/>
		<property name="ibatisPropertyDao" ref="ibatisPropertyDao"/>
	</bean>
	
	<bean id="ibatisAssociationDao"
		class="org.lexevs.dao.database.ibatis.association.IbatisAssociationDao" parent="abstractIbatisDao">
		<property name="versionsDao" ref="ibatisVersionsDao"/>
		<property name="codingSchemeDao" ref="ibatisCodingSchemeDao"/>
	</bean>
    
    <bean id="ibatisVersionsDao"
		class="org.lexevs.dao.database.ibatis.versions.IbatisVersionsDao" parent="abstractIbatisDao">
	</bean>
		
	<bean id="databaseServiceManager" class="org.lexevs.dao.database.service.DatabaseServiceManager">
		<property name="codingSchemeService" ref="codingSchemeService"/>
		<property name="propertyService" ref="propertyService"/>
		<property name="entityService" ref="entityService"/>
	</bean>
	
	<bean id="abstractService" abstract="true">
		<property name="daoManager" ref="daoManager"/>
	</bean>
	
	<bean id="codingSchemeService" 
		class="org.lexevs.dao.database.service.codingscheme.VersionableEventCodingSchemeService"
		parent="abstractService">
		<property name="entityService" ref="entityService"/>
	</bean>
		
	<bean id="propertyService" 
		class="org.lexevs.dao.database.service.property.VersionableEventPropertyService"
		parent="abstractService"/>
		
	<bean id="entityService" 
		class="org.lexevs.dao.database.service.entity.VersionableEventEntityService"
		parent="abstractService"/>

	<bean id="compass" class="org.compass.spring.LocalCompassBean">
		<property name="compassSettings">
			<props>
				<prop key="compass.engine.connection">file://test-compass</prop>
			</props>
		</property>
	</bean>
	
	<bean id="compassSearchHelper" class="org.compass.core.support.search.CompassSearchHelper">
		<constructor-arg index="0"><ref bean="compass"/></constructor-arg>
	</bean>

	<bean id="lexEvsJdbcTemplate"
		class="org.springframework.jdbc.core.JdbcTemplate">
		<property name="dataSource">
			<ref bean="dataSource" />
		</property>
	</bean>
	
	<bean id="sqlMapClientTemplate" class="org.springframework.orm.ibatis.SqlMapClientTemplate">
		<property name="dataSource" ref="dataSource"/>
		<property name="sqlMapClient" ref="sqlMap"/>
	</bean>
    
    <bean id="abstractResourceManagerVariableFactory" 
     	class="org.lexevs.system.constants.IndividualVariableFactory"
     	abstract="true">
     	<property name="bean" ref="resourceManager"/>
     </bean>
    
     <bean id="transactionManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">  
   		<property name="dataSource" ref="dataSource"/>  
	</bean>
	
	<bean id="defaultPrefixResolver" class="org.lexevs.dao.database.prefix.DefaultPrefixResolver">
		<property name="systemVariables" ref="systemVariables"/> 
		<property name="registry" ref="databaseRegistry"/> 
	</bean>
	
	<bean id="hibernateRegistryDao" class="org.lexevs.dao.database.hibernate.registry.HibernateRegistryDao">
		<property name="sessionFactory" ref="registrySessionFactory"/>
	</bean>
	
	<bean id="unPooledDataSource" class="org.springframework.jdbc.datasource.SimpleDriverDataSource" >
		<property name="driverClass" ref="jdbcDriverClass" />
		<property name="url" ref="dbUrl" />
		<property name="username" ref="dbUser"/>
		<property name="password" ref="dbPassword"/>
	</bean>
	
	<bean id="validationQueryFactory"
		class="org.lexevs.dao.database.utility.DatabaseValidationQueryFactory">
			<property name="dbUrl" ref="dbUrl"/>
	</bean>
	
	<bean id="jdbcDriverClass" class="org.lexevs.dao.database.utility.JdbcDriverBootstrap">
		<property name="classLoader" ref="myClassLoader"/>
		<property name="driverClass" ref="dbDriver" />
	</bean>
	
	 <bean id="dsConnectionFactory" class="org.apache.commons.dbcp.DataSourceConnectionFactory">
        <constructor-arg><ref bean="unPooledDataSource"/></constructor-arg>
    </bean>
    
    <bean id="myClassLoader" class="org.lexevs.system.utility.MyClassLoader">
    	<constructor-arg ref="systemVariables"/>
    	<constructor-arg ref="loggerFactory"/>
    </bean>
    
	
	<bean id="pool" class="org.apache.commons.pool.impl.GenericObjectPool">
		<property name="maxActive">
			<value>150</value>
		</property>
		<property name="maxIdle">
			<value>2</value>
		</property>
		<property name="testOnBorrow" value="true"/>
    </bean>
    
	<bean id="poolableConnectionFactory" class="org.apache.commons.dbcp.PoolableConnectionFactory">
        <constructor-arg index="0"><ref bean="dsConnectionFactory"/></constructor-arg>
        <constructor-arg index="1"><ref bean="pool"/></constructor-arg>
        <constructor-arg index="2"><null/></constructor-arg>
        <constructor-arg index="3" ref="validationQueryFactory"/>
        <constructor-arg index="4"><value>false</value></constructor-arg>
        <constructor-arg index="5"><value>true</value></constructor-arg>
    </bean>
    
    <bean id="loggerFactory" class="org.lexevs.logging.LoggerFactory" factory-method="getLogger"/>
    
    <bean id="systemVariables" class="org.lexevs.system.constants.SystemVariables">
    	<constructor-arg ref="loggerFactory"/>
    </bean>
    
     <bean id="abstractSystemVariableFactory" 
     	class="org.lexevs.system.constants.IndividualVariableFactory"
     	abstract="true">
     	<property name="bean" ref="systemVariables"/>
     </bean>
    
    <bean id="dbUrl" parent="abstractSystemVariableFactory">
    	<property name="variableName" value="AutoLoadDBURL"/>
    </bean>
    
    <bean id="dbPassword" parent="abstractSystemVariableFactory">
    	<property name="variableName" value="AutoLoadDBPassword"/>
    </bean>
    
    <bean id="dbUser" parent="abstractSystemVariableFactory">
    	<property name="variableName" value="AutoLoadDBUsername"/>
    </bean>
    
    <bean id="dbDriver" parent="abstractSystemVariableFactory">
    	<property name="variableName" value="AutoLoadDBDriver"/>
    </bean>
    
    <bean id="dataSource" class="org.apache.commons.dbcp.PoolingDataSource" depends-on="poolableConnectionFactory">
        <constructor-arg><ref bean="pool"/></constructor-arg>
    </bean>
    
    <bean id="defaultLexEvsDatabaseOperations" class="org.lexevs.dao.database.operation.DefaultLexEvsDatabaseOperations">
   	 	<property name="databaseUtility" ref="defaultDatabaseUtility" />
   		<property name="lexevsCommonSchemaCreateScript" ref="lexevsCommonSchemaCreateScript"/>
   		<property name="lexevsCodingSchemeSchemaCreateScript" ref="lexevsCodingSchemeSchemaCreateScript"/>
   		<property name="prefixResolver" ref="defaultPrefixResolver"/>
   		<property name="dataSource" ref="dataSource"/>
   		<property name="databaseType" ref="databaseTypeFactory"/>
   	 </bean>
   	 
   	<bean id="lexevsCodingSchemeSchemaCreateScript"
		class="org.lexevs.dao.database.setup.script.ScriptFactory">
		<property name="scriptType" value="create"/>
		<property name="databaseType" ref="databaseTypeFactory"/>
		<property name="creationScriptPrefix" value="sql/lexevs/codingscheme-create-"/>
	</bean>
	
	<bean id="lexevsCommonSchemaCreateScript"
		class="org.lexevs.dao.database.setup.script.ScriptFactory">
		<property name="scriptType" value="create"/>
		<property name="databaseType" ref="databaseTypeFactory"/>
		<property name="creationScriptPrefix" value="sql/lexevs/common-create-"/>
	</bean>
	
	
	<bean id="registrySessionFactory" class="org.springframework.orm.hibernate3.LocalSessionFactoryBean">
		<property name="dataSource">
			<ref bean="dataSource" />
		</property>
		<property name="entityInterceptor" ref="prefixInterceptor"/>
		<property name="configLocations" value="classpath:hibernate/registry/hibernate.cfg.xml"/>
		<property name="configurationClass" value="org.hibernate.cfg.AnnotationConfiguration"/>	
	</bean>

	<bean id="prefixInterceptor" class="org.lexevs.dao.database.hibernate.prefix.PrefixInterceptor">
		<property name="prefixResolver" ref="defaultPrefixResolver"/>
	</bean>
	
	<bean id="databaseRegistry" class="org.lexevs.registry.service.DatabaseRegistry">
		<property name="registryDao" ref="hibernateRegistryDao"/>
		<property name="nextDatabasePrefixGenerator" ref="cyclingCharDbPrefixGenerator"/>
	</bean>
	
	<bean id="cyclingCharDbPrefixGenerator" class="org.lexevs.dao.database.prefix.CyclingCharDbPrefixGenerator">
		<property name="databaseUtility" ref="defaultDatabaseUtility"/>
		<property name="prefixResolver" ref="defaultPrefixResolver"/>
	</bean>
	
	<bean id="resourceManager" class="org.lexevs.system.ResourceManager" init-method="init" depends-on="lexEvsSchemaInstallationSetup">
		<property name="systemVariables" ref="systemVariables"/>
		<property name="logger" ref="loggerFactory"/>
	</bean>
	
	<bean id="delegatingResourceManagingService" class="org.lexevs.system.service.DelegatingResourceManagingService">
		<property name="prefixResolver" ref="defaultPrefixResolver"/>
		<property name="systemVariables" ref="systemVariables"/> 
		<property name="lexEvsDatabaseOperations" ref="defaultLexEvsDatabaseOperations"/>
		<property name="registry" ref="databaseRegistry"/>
		<property name="myClassLoader" ref="myClassLoader"/>
	</bean>
	
	<bean id="lexEvsSchemaInstallationSetup" class="org.lexevs.registry.setup.LexEvsSchemaInstallationSetup"
		parent="loggingBean">
		<property name="lexGridSchemaInstalled" ref="lexGridSchemaCheckFactory"/>
		<property name="systemVariables" ref="systemVariables"/> 
		<property name="lexEvsDatabaseOperations" ref="defaultLexEvsDatabaseOperations"/>
		<property name="registryDao" ref="hibernateRegistryDao"/>
	</bean>
	
    <bean id="defaultDatabaseUtility"
		class="org.lexevs.dao.database.utility.DefaultDatabaseUtility">
		<property name="dataSource" ref="dataSource" />
	</bean>
	
	<bean id="lexGridSchemaCheckFactory"
		class="org.lexevs.dao.database.setup.schemacheck.LexGridSchemaCheckFactory">
		<property name="dataSource" ref="dataSource"/>  
		<property name="databaseType" ref="databaseTypeFactory"/>  
		<property name="prefixResolver" ref="defaultPrefixResolver"/>
	</bean>
	
	<tx:annotation-driven proxy-target-class="true" transaction-manager="transactionManager"/>
	
	<bean id="databaseTypeFactory" class="org.lexevs.dao.database.type.DatabaseTypeFactory">
		<property name="dataSource" ref="dataSource"/> 
	</bean>
	
	<bean id="lexEvsServiceLocator" class="org.lexevs.locator.LexEvsServiceLocator">
		<property name="resourceManager" ref="resourceManager"/>
		<property name="lexEvsDatabaseOperations" ref="defaultLexEvsDatabaseOperations"/>
		<property name="databaseServiceManager" ref="databaseServiceManager"/>
		<property name="systemResourceService" ref="delegatingResourceManagingService"/>
		<property name="registry" ref="databaseRegistry"/>
	</bean>
	
	<bean id="loggingBean" class="org.lexevs.logging.LoggingBean" abstract="true">
		<property name="logger" ref="loggerFactory"/>
	</bean>
	
</beans>
