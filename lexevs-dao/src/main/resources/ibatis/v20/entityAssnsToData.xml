<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL MAP 2.0//EN" 
	"http://www.ibatis.com/dtd/sql-map-2.dtd">
<sqlMap namespace="Association">

	<typeAlias alias="associationData" type="org.lexevs.dao.database.ibatis.association.parameter.InsertOrUpdateAssociationDataBean"/>

	<resultMap id="associationDataEntry" class="associationData" groupBy="uid">
		<result property="uid" column="entityAssnsDataGuid" />
		<result property="associationPredicateUId" column="associationPredicateGuid" />
		<result property="associationSource.sourceEntityCode" column="sourceEntityCode" />
		<result property="associationSource.sourceEntityCodeNamespace" column="sourceEntityCodeNamespace" />
		<result property="associationData.associationInstanceId" column="associationInstanceId" />
		<result property="associationData.isDefining" column="isDefining" />
		<result property="associationData.isInferred" column="isInferred" />
		<result property="associationData.associationDataText.content" column="dataValue" />
		<result property="associationData.isActive" column="isActive" />
		<result property="associationData.owner" column="owner" />
		<result property="associationData.status" column="status" />
		<result property="associationData.effectiveDate" column="effectiveDate" />
		<result property="associationData.expirationDate" column="expirationDate" />
		<result property="entryStateUId" column="entryStateGuid" />
		<result property="assnQualsAndUsageContextList" resultMap="Association.qualContextResult"/>
	</resultMap>

	<insert id="insertEntityAssnsToData"
		parameterClass="org.lexevs.dao.database.ibatis.association.parameter.InsertOrUpdateAssociationDataBean">
		INSERT INTO $prefix$entityAssnsToData (
			entityAssnsDataGuid,
			associationPredicateGuid,
			sourceEntityCode,
			sourceEntityCodeNamespace,
			associationInstanceId,
			isDefining,
			isInferred,
			dataValue,
			isActive,
			owner,
			status,
			effectiveDate,
			expirationDate,
			entryStateGuid
		) VALUES (
			#uid#,
			#associationPredicateUId#,
			#associationSource.sourceEntityCode#,
			#associationSource.sourceEntityCodeNamespace#,
			#associationData.associationInstanceId#,
			#associationData.isDefining#,
			#associationData.isInferred#,
			#associationData.associationDataText.content#,
			#associationData.isActive#,
			#associationData.owner#,
			#associationData.status#,
			#associationData.effectiveDate#,
			#associationData.expirationDate#,
			#entryStateUId#
		)
  </insert>
  	
	<select id="getEntityAssnDataUIDByAssocInstanceId" remapResults="true" resultClass="string">
		SELECT
			ead.entityAssnsDataGuid
		FROM 
			$prefix$entityAssnsToData ead
		JOIN
			$prefix$associationPredicate ap
		ON 
			ead.associationPredicateGuid =
			ap.associationPredicateGuid
		JOIN
			$prefix$relation rel
		ON
			ap.relationGuid =
			rel.relationGuid
		WHERE
			rel.codingSchemeGuid = 
			#param1#
		AND
			ead.associationInstanceId = 
			#param2#
	</select>
	
	<select id="getAssnDataAttributesByUId"
		parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter"
		remapResults="true" resultMap="associationDataEntry">		
		SELECT 
			data.entityAssnsDataGuid,
			data.associationPredicateGuid,
			data.sourceEntityCode,
			data.sourceEntityCodeNamespace,
			data.associationInstanceId,
			data.isDefining,
			data.isInferred,
			data.dataValue,
			data.isActive,
			data.owner,
			data.status,
			data.effectiveDate,
			data.expirationDate,
			data.entryStateGuid,
			quals.entityAssnQualsGuid,
			quals.referenceGuid,
			quals.qualifierName,
			quals.qualifierValue,
			quals.entryStateGuid esGuid
		FROM
			$prefix$entityAssnsToData data
		LEFT JOIN
			$prefix$entityAssnQuals quals
		ON
			data.entityAssnsDataGuid = quals.referenceGuid
		WHERE
			data.entityAssnsDataGuid = #param1# 
	</select>
	
	<update id="updateEntityAssnToDataByUId"
		parameterClass="org.lexevs.dao.database.ibatis.association.parameter.InsertOrUpdateAssociationDataBean">
		UPDATE
			$prefix$entityAssnsToData
		SET
		<dynamic prepend=" ">
			<isNotNull prepend="," property="associationSource.sourceEntityCode">
				sourceEntityCode = #associationSource.sourceEntityCode#
			</isNotNull>
			<isNotNull prepend="," property="associationSource.sourceEntityCodeNamespace">
				sourceEntityCodeNamespace = #associationSource.sourceEntityCodeNamespace#
			</isNotNull>
			<isNotNull prepend="," property="associationData.isDefining">
				isDefined = #associationData.isDefining#
			</isNotNull>
			<isNotNull prepend="," property="associationData.isInferred">
				isInferred = #associationData.isInferred#
			</isNotNull>
			<isNotNull prepend="," property="associationData.associationDataText">
				dataValue = #associationData.associationDataText.content#
			</isNotNull>
			<isNotNull prepend="," property="entryStateUId">
				entryStateGuid = #entryStateUId#
			</isNotNull>
		</dynamic>
		WHERE
			entityAssnsDataGuid = #uid#
	</update>	

	<update id="updateEntityAssnToDataVerAttribByUId"
		parameterClass="org.lexevs.dao.database.ibatis.association.parameter.InsertOrUpdateAssociationDataBean">
		UPDATE
			$prefix$entityAssnsToData
		SET
		<dynamic prepend=" ">
			<isNotNull prepend="," property="associationData.isActive">
				isActive =
				#associationData.isActive#
			</isNotNull>
			<isNotNull prepend="," property="associationData.owner">
				owner = #associationData.owner#
			</isNotNull>
			<isNotNull prepend="," property="associationData.status">
				status = #associationData.status#
			</isNotNull>
			<isNotNull prepend="," property="associationData.effectiveDate">
				effectiveDate =
				#associationData.effectiveDate#
			</isNotNull>
			<isNotNull prepend="," property="associationData.expirationDate">
				expirationDate =
				#associationData.expirationDate#
			</isNotNull>
			<isNotNull prepend="," property="entryStateUId">
				entryStateGuid = #entryStateUId#
			</isNotNull>
		</dynamic>
		WHERE
			entityAssnsDataGuid = #uid#
	</update>	
		
	<delete id="deleteAssocDataByAssnUId" parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter">
		DELETE FROM
			$prefix$entityAssnsToData
		WHERE
			entityAssnsDataGuid = #param1#
	</delete>

	<select id="getAssociationDataLatestRevisionIdByUId" remapResults="true"
		parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameter"
		resultClass="string">
		SELECT 
			rev.revisionId
		FROM
			$prefix$entityAssnsToData entAssnData,
			$prefix$entryState es,
			${defaultPrefix}revision rev
		WHERE
			entAssnData.entityAssnsDataGuid = #param1#	
		AND
			entAssnData.entryStateGuid = es.entryStateGuid
		AND
			es.revisionGuid = rev.revisionGuid	
	</select> 	
</sqlMap>