<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL MAP 2.0//EN" 
	"http://www.ibatis.com/dtd/sql-map-2.dtd">
<sqlMap namespace="Property">

	<typeAlias alias="property" type="org.LexGrid.commonTypes.Property" />
	<typeAlias alias="presentation" type="org.LexGrid.concepts.Presentation"/>
	<typeAlias alias="definition" type="org.LexGrid.concepts.Definition"/>
	<typeAlias alias="comment" type="org.LexGrid.concepts.Comment"/>
	

	<resultMap id="propertyResult" class="property" groupBy="propertyId">
		<result property="propertyName" column="propertyName" />	
		<result property="propertyId" column="propertyId" />
		<result property="propertyType" column="propertyType" />
		<result property="language" column="language" />
		<result property="value.content" column="propertyValue" />
		<result property="value.dataType" column="format" />
<!--		<result property="_sourceList" resultMap="Property.multiAttribResult"/>-->
<!--		<result property="_propertyQualifierList" resultMap="Property.multiAttribResult"/>-->
<!--		<result property="_usageContextList" resultMap="Property.multiAttribResult"/>-->
		<discriminator javaType="string" column="propertyType">
			<subMap value="presentation" resultMap="presentationResult" />
			<subMap value="definition" resultMap="definitionResult" />
			<subMap value="comment" resultMap="commentResult" />
		</discriminator>	
	</resultMap>
	
	<resultMap id="presentationResult" class="presentation" extends="propertyResult" >
		<result property="isPreferred" column="isPreferred" />
		<result property="degreeOfFidelity" column="degreeOfFidelity"/>
		<result property="matchIfNoContext" column="matchIfNoContext"/>
		<result property="representationalForm" column="representationalForm"/>
	</resultMap>
	
	<resultMap id="definitionResult" class="definition" extends="propertyResult" >
		<result property="isPreferred" column="isPreferred" />
	</resultMap>
	
	<resultMap id="commentResult" class="comment" extends="propertyResult" />
	
	<select id="getPropertyId" resultClass="string" parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameterTuple">
  		SELECT
  			propertyGuid
  		FROM
  			$prefix$property
  		WHERE
			referenceGuid = #param1#
		AND
			propertyId = #param2#
  	</select>
  	
  	<sql id="getPropertyFragment">
  	  	SELECT
  			property.referenceType,
  			property.propertyId,
  			property.propertyType,
  			property.propertyName,
  			property.language,
  			property.format,
  			property.isPreferred,
  			property.matchIfNoContext,
  			property.degreeOfFidelity,
  			property.representationalForm,
  			property.propertyValue,
  			entryState.changeType,
  			entryState.relativeOrder
  		FROM
  			$prefix$property property
  		LEFT JOIN
  			${defaultPrefix}entryState entryState
  		ON
  			property.entryStateGuid =
  			entryState.entryStateGuid		
  	</sql>

  	<select id="getPropertiesByParent" resultMap="propertyResult" parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameterTuple">
		<include refid="getPropertyFragment"/>
  		WHERE
			property.referenceType = #param1#
		AND 
			property.referenceGuid = #param2#
  	</select>
  	
  	<select id="getPropertiesByParentAndRevisionId" resultMap="propertyResult" parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameterTriple">
		<include refid="getPropertyFragment"/>
  		WHERE
			property.referenceType = #param1#
		AND 
			property.referenceGuid = #param2#
		AND 
			entryState.revisionGuid = #param3#
  	</select>

	<delete id="deleteEntityPropertiesByCodingSchemeId" parameterClass="org.lexevs.dao.database.ibatis.parameter.PrefixedParameterTuple">
		DELETE FROM
			$prefix$property
		WHERE
			referenceType = #param1#
		AND 
			referenceGuid
		IN	(
			SELECT 
				entityGuid
			FROM
				$prefix$entity
			WHERE
				codingSchemeGuid = #param2#
			)
	</delete>
	
     <insert id="insertProperty" parameterClass="org.lexevs.dao.database.ibatis.property.parameter.InsertPropertyBean">
		INSERT INTO $prefix$property (
			propertyGuid,
			referenceGuid,
			referenceType,
			propertyId,
			propertyType,
			propertyName,
			language,
			format,
			isPreferred,
			matchIfNoContext,
			degreeOfFidelity,
			representationalForm,
			propertyValue,
			isActive,
			owner,
			status,
			effectiveDate,
			expirationDate,
			entryStateGuid
		) VALUES (
			#id#, 
			#entityId#,
			#referenceType#, 
			#property.propertyId#, 
			#property.propertyType#,
			#property.propertyName#,
			#property.language#,
			#property.value.dataType#,
			
			<isPropertyAvailable property="property.isPreferred">
				#property.isPreferred#,
			</isPropertyAvailable>
			<isNotPropertyAvailable property="property.isPreferred">
				null,
			</isNotPropertyAvailable>
			
			<isPropertyAvailable property="property.matchIfNoContext">
				#property.matchIfNoContext#,
			</isPropertyAvailable>
			<isNotPropertyAvailable property="property.matchIfNoContext">
				null,
			</isNotPropertyAvailable>
			
			<isPropertyAvailable property="property.degreeOfFidelity">
				#property.degreeOfFidelity#,
			</isPropertyAvailable>
			<isNotPropertyAvailable property="property.degreeOfFidelity">
				null,
			</isNotPropertyAvailable>
			
			<isPropertyAvailable property="property.representationalForm">
				#property.representationalForm#,
			</isPropertyAvailable>
			<isNotPropertyAvailable property="property.representationalForm">
				null,
			</isNotPropertyAvailable>
			
			#property.value.content#,	
			#property.isActive#,
			#property.owner#,
			#property.status#,
			#property.effectiveDate#,
			#property.expirationDate#,
			#entryStateId#
		)
  </insert>
    
</sqlMap>